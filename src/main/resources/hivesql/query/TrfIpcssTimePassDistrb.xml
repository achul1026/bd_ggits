<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE mapper PUBLIC '-//mybatis.org//DTD Mapper 3.0//EN' 'http://mybatis.org/dtd/mybatis-3-mapper.dtd'>

<mapper namespace='com.neighbor21.ggits.common.hivesql.mapper.TrfIpcssTimePassDistrbMapper'>
	<select id="findOneUsgCdNmList" parameterType="trfvlmStatisticsDTO" resultType="map">
		SELECT 
			COLLECT_LIST(A.USG_CD) AS cdNmArr
		FROM (
			SELECT 
				TRFVLM_RESULT.USG_CD
			FROM(
				SELECT
					TICTI.USG_CD
				FROM (
					SELECT
						titpb.USG_CD
					FROM
						GGITS.TRF_IPCSS_TIME_PASS_DISTRB titpb
					WHERE titpb.IPCSS_MNG_NO = #{ipcssMngNo} AND titpb.DYWK_DIV = #{dywkDiv}
					GROUP BY titpb.USG_CD
				) TICTI
				GROUP by TICTI.USG_CD
				ORDER BY TICTI.USG_CD
			) TRFVLM_RESULT
			GROUP BY TRFVLM_RESULT.USG_CD
			ORDER BY TRFVLM_RESULT.USG_CD
		)A
	</select>

	<select id="findAllTimePassDistrbList" parameterType="trfvlmStatisticsDTO" resultType="timePassDistrbDTO">
		SELECT 
				TRFVLM_RESULT.TIME_SCTN_NM,
				COLLECT_LIST(
					NAMED_STRUCT(
						'inflRt', INFL_RT,
		        		'outflRt', OUTFL_RT
					)
				) AS TRFVLM_STATISTICS_LIST_JSON
			FROM(
				SELECT
					TIME_SCTN_NM,
					TRF_USE_CD,
					concat_ws(',', collect_list(INFL_RT)) AS INFL_RT,
					concat_ws(',', collect_list(OUTFL_RT)) AS OUTFL_RT
				FROM (
					SELECT
						TIME_SCTN_NM,
						TRF_USE_CD,
						USG_CD,
						ROUND(INFL_RT, 2) as INFL_RT,
						ROUND(OUTFL_RT, 2) as OUTFL_RT
					FROM
						GGITS.TRF_IPCSS_TIME_PASS_DISTRB
					WHERE IPCSS_MNG_NO = #{ipcssMngNo} AND DYWK_DIV = #{dywkDiv}
					GROUP BY TIME_SCTN_NM,USG_CD,TRF_USE_CD,INFL_RT,OUTFL_RT
				) TICTI
				GROUP BY TICTI.TIME_SCTN_NM,TICTI.USG_CD,TICTI.TRF_USE_CD
				ORDER BY TICTI.TIME_SCTN_NM,TICTI.USG_CD,TICTI.TRF_USE_CD
			) TRFVLM_RESULT
			GROUP BY 	TRFVLM_RESULT.TIME_SCTN_NM
			ORDER BY 	TRFVLM_RESULT.TIME_SCTN_NM
	</select>

	<select id="findAllChartDataForDwell" parameterType="map" resultType="map">
		SELECT 
				COLLECT_LIST(A.hour) AS timeDataArray,
				COLLECT_LIST(A.INFL_RT) as inflRtDataArray,
				COLLECT_LIST(A.OUTFL_RT) as outflRtDataArray
			FROM(
				SELECT
					TIME_DATA.hour
					,COALESCE(GRAPH_DATA.INFL_RT,0) as INFL_RT
					, COALESCE(GRAPH_DATA.OUTFL_RT,0) as OUTFL_RT
				FROM(
					SELECT 
						posexplode(array('00','01','02','03','04','05','06','07','08','09','10','11','12','13','14','15','16','17','18','19','20','21','22','23')) AS (pos, hour)
				) TIME_DATA
				LEFT JOIN (
						SELECT
							INFL_RT,
							OUTFL_RT,
							SUBSTRING(time_sctn_nm,1,2) as timeSctnNm
						FROM
								GGITS.TRF_IPCSS_TIME_PASS_DISTRB
						WHERE 1=1
							and IPCSS_MNG_NO = #{ipcssMngNo}
							AND USG_CD = #{usgCd} 
							AND TRF_USE_CD = #{trfUseCd}
							and dywk_div = #{dywkDiv}
						GROUP by 
							SUBSTRING(TIME_SCTN_NM,1,2),INFL_RT, OUTFL_RT
						ORDER BY timeSctnNm ASC	
		  		) GRAPH_DATA on TIME_DATA.hour = GRAPH_DATA.timeSctnNm
				ORDER BY TIME_DATA.hour ASC
			)A
	</select>
	
	<select id="findAllChartDataForNonDwell" parameterType="map" resultType="map">
		SELECT 
				COLLECT_LIST(A.hour) AS timeDataArray,
				COLLECT_LIST(A.INFL_RT) as inflRtDataArray,
				COLLECT_LIST(A.OUTFL_RT) as outflRtDataArray
			FROM(
				SELECT
					TIME_DATA.hour
					,COALESCE(GRAPH_DATA.INFL_RT,0) as INFL_RT
					, COALESCE(GRAPH_DATA.OUTFL_RT,0) as OUTFL_RT
				FROM(
					SELECT 
						posexplode(array('00','01','02','03','04','05','06','07','08','09','10','11','12','13','14','15','16','17','18','19','20','21','22','23')) AS (pos, hour)
				) TIME_DATA
				LEFT JOIN (
						SELECT
						sum(INFL_RT) as INFL_RT,
						sum(OUTFL_RT) as OUTFL_RT,
						SUBSTRING(time_sctn_nm,1,2) as timeSctnNm
						FROM
								GGITS.TRF_IPCSS_TIME_PASS_DISTRB
						WHERE 1=1
							and IPCSS_MNG_NO = #{ipcssMngNo}
							AND USG_CD = #{usgCd} 
							AND TRF_USE_CD = #{trfUseCd}
							and dywk_div = #{dywkDiv}
						GROUP by 
							SUBSTRING(TIME_SCTN_NM,1,2),INFL_RT, OUTFL_RT
						ORDER BY timeSctnNm ASC	
		  		) GRAPH_DATA on TIME_DATA.hour = GRAPH_DATA.timeSctnNm
				ORDER BY TIME_DATA.hour ASC
			)A		
	</select>
	
	<select id="findOneUsgCdNmListForChart" parameterType="trfvlmStatisticsDTO" resultType="String">
		SELECT
			fitpd.USG_CD 
		FROM GGITS.TRF_IPCSS_TIME_PASS_DISTRB fitpd
		WHERE fitpd.IPCSS_MNG_NO = #{ipcssMngNo} AND fitpd.DYWK_DIV = #{dywkDiv}
		GROUP BY fitpd.USG_CD 
	</select>
	
	<select id="findOneBizInfo" parameterType="trfvlmStatisticsDTO" resultType="trfIpcssTimePassDistrb">
		SELECT
			TITPB.BIZ_NM 
			, TITPB.BIZ_USG 
		FROM GGITS.TRF_IPCSS_TIME_PASS_DISTRB TITPB
		WHERE TITPB.IPCSS_MNG_NO = #{ipcssMngNo} AND BIZ_NM IS NOT NULL AND BIZ_USG IS NOT NULL
		GROUP BY TITPB.BIZ_NM, TITPB.BIZ_USG 
	</select>

	<insert id="saveTimePassDistrb" parameterType="trfIpcssTimePassDistrb">
		INSERT INTO GGITS.TRF_IPCSS_TIME_PASS_DISTRB
			VALUES(
			#{ipcssMngNo}, 
			#{dywkDiv}, 
			#{usgCd}, 
			CAST(#{usgSqno} as int),
			#{trfUseCd}, 
			#{timeSctnNm}, 
			#{inflRt}, 
			#{outflRt}, 
			#{totInflRt},
			#{totOutflRt},
			FROM_UNIXTIME(UNIX_TIMESTAMP(), 'yyyyMMddHHmmss'))
	</insert>
	
	<delete id="deleteTrafficImpactReportByIpcssMngNo" parameterType="String">
		DELETE 
		FROM
			GGITS.TRF_IPCSS_TIME_PASS_DISTRB
		WHERE
			IPCSS_MNG_NO = #{ipcssMngNo}
	</delete>
</mapper>
