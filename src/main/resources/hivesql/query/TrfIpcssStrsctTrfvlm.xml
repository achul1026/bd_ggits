<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE mapper PUBLIC '-//mybatis.org//DTD Mapper 3.0//EN' 'http://mybatis.org/dtd/mybatis-3-mapper.dtd'>

<mapper namespace='com.neighbor21.ggits.common.hivesql.mapper.TrfIpcssStrsctTrfvlmMapper'>
	<insert id="saveStrsctTrfvlm" parameterType="trfIpcssStrsctTrfvlm">
		INSERT INTO GGITS.TRF_IPCSS_STRSCT_TRFVLM
			VALUES(
			#{ipcssMngNo}, 
			#{dywkDiv},
			#{exmnYmd},
			CAST(#{exmnNo} as int),
			#{strsctNm}, 
			#{strsctDrctNm}, 
			#{timeSctnNm}, 
			#{psgvhclTrfvlm}, 
			#{busTrfvlm}, 
			#{busLrgszTrfvlm}, 
			#{frghtSmlszTrfvlm}, 
			#{frghtMdmszTrfvlm}, 
			#{frghtLrgszTrfvlm},
			FROM_UNIXTIME(UNIX_TIMESTAMP(), 'yyyyMMddHHmmss'),
			CAST(#{strsctDrctNo} as int)
			);
	</insert>
	
	<delete id="deleteTrafficImpactReportByIpcssMngNo" parameterType="String">
		DELETE 
		FROM
			GGITS.TRF_IPCSS_STRSCT_TRFVLM
		WHERE
			IPCSS_MNG_NO = #{ipcssMngNo}
	</delete>
	
	<delete id="deleteTrafficImpactReportForDywkDiv" parameterType="trfvlmStatisticsDTO">
		DELETE 
		FROM
			GGITS.TRF_IPCSS_STRSCT_TRFVLM
		WHERE
			IPCSS_MNG_NO = #{ipcssMngNo}
			AND DYWK_DIV = #{dywkDiv}
	</delete>
	
	<select id="findAllStrsctTrfvlmStatisticsList" parameterType="trfvlmStatisticsDTO" resultType="trfvlmStatisticsDTO">
		SELECT
			TRFVLM_RESULT.EXMN_NO AS DATA_NO,
			TRFVLM_RESULT.STRSCT_NM AS NAME,
			TRFVLM_RESULT.EXMN_YMD AS EXMN_YMD,
		  	TRFVLM_RESULT.HEADER_LIST,
		  	COLLECT_LIST(
		    NAMED_STRUCT(
		      'timeSctnNm', TRFVLM_RESULT.TIME_SCTN_NM,
		      'timeTrfvlmDataList', TRFVLM_RESULT.TIME_TRFVLM_DATA_LIST
		    )
		  ) AS TIME_TRFVLM_RESULT_LIST
		FROM (
		  SELECT
		    TICTI.STRSCT_NM,
		    TICTI.EXMN_NO,
		    TICTI.EXMN_YMD,
		    TICTI.TIME_SCTN_NM,
		    COLLECT_LIST(STRSCT_DRCT_NM) AS HEADER_LIST,
		    COLLECT_LIST(
		      NAMED_STRUCT(
		        'psgvhclTrfvlm', TICTI.PSGVHCL_TRFVLM,
		        'busTrfvlm', TICTI.bus_smlsz_trfvlm,
		        'busLrgszTrfvlm', TICTI.BUS_LRGSZ_TRFVLM,
		        'frghtSmlszTrfvlm', TICTI.FRGHT_SMLSZ_TRFVLM,
		        'frghtMdmszTrfvlm', TICTI.FRGHT_MDMSZ_TRFVLM,
		        'frghtLrgszTrfvlm', TICTI.FRGHT_LRGSZ_TRFVLM,
		        'totalCnt', TICTI.TOTAL_CNT
		      )
		    ) AS TIME_TRFVLM_DATA_LIST
		  FROM (
		    SELECT
		      STRSCT_NM,
		      EXMN_NO,
		      EXMN_YMD,
		      STRSCT_DRCT_NO,
		      STRSCT_DRCT_NM,
		      TIME_SCTN_NM,
		      COALESCE(SUM(PSGVHCL_TRFVLM +
		        BUS_SMLSZ_TRFVLM +
		        BUS_LRGSZ_TRFVLM +
		        FRGHT_SMLSZ_TRFVLM +
		        FRGHT_MDMSZ_TRFVLM +
		        FRGHT_LRGSZ_TRFVLM), 0) AS TOTAL_CNT,
		      SUM(COALESCE(PSGVHCL_TRFVLM, 0)) AS PSGVHCL_TRFVLM,
		      SUM(COALESCE(BUS_SMLSZ_TRFVLM, 0)) AS BUS_SMLSZ_TRFVLM,
		      SUM(COALESCE(BUS_LRGSZ_TRFVLM, 0)) AS BUS_LRGSZ_TRFVLM,
		      SUM(COALESCE(FRGHT_SMLSZ_TRFVLM, 0)) AS FRGHT_SMLSZ_TRFVLM,
		      SUM(COALESCE(FRGHT_MDMSZ_TRFVLM, 0)) AS FRGHT_MDMSZ_TRFVLM,
		      SUM(COALESCE(FRGHT_LRGSZ_TRFVLM, 0)) AS FRGHT_LRGSZ_TRFVLM
		    FROM
		      ggits.TRF_IPCSS_STRSCT_TRFVLM
		   	WHERE
					IPCSS_MNG_NO = #{ipcssMngNo}
					AND DYWK_DIV = <choose>
										<when test="dywkDiv != null and dywkDiv != ''">
											#{dywkDiv}
										</when>
										<otherwise>
											'평일'
										</otherwise>
									</choose>
		    GROUP BY
		      TIME_SCTN_NM,STRSCT_NM,EXMN_NO,STRSCT_DRCT_NO,STRSCT_DRCT_NM,EXMN_YMD
		   order by TIME_SCTN_NM,STRSCT_DRCT_NO
		  ) TICTI
		  GROUP BY
		    TICTI.TIME_SCTN_NM,TICTI.STRSCT_NM,TICTI.EXMN_NO,TICTI.EXMN_YMD
		  ORDER BY TICTI.EXMN_NO,TICTI.TIME_SCTN_NM
		) TRFVLM_RESULT
		GROUP BY
		  TRFVLM_RESULT.EXMN_NO,TRFVLM_RESULT.STRSCT_NM,TRFVLM_RESULT.HEADER_LIST,TRFVLM_RESULT.EXMN_YMD
		ORDER BY
		  CAST(TRFVLM_RESULT.EXMN_NO AS INT);
  
	</select>
	
	<select id="findAllStrsctTrfvlmStatisticsGraphList" parameterType="trfvlmStatisticsDTO" resultType="trfvlmStatisticsGraphDTO">
		SELECT
		    GRAPH_RESULT_DATA.STRSCT_DRCT_NM,
		    CONCAT(
		        CAST(GRAPH_RESULT_DATA.TOTAL_SUM_CNT AS STRING), ',',
		        CAST(GRAPH_RESULT_DATA.TOTAL_AM_SUM_CNT AS STRING), ',',
		        CAST(GRAPH_RESULT_DATA.TOTAL_PM_SUM_CNT AS STRING), ',',
		        CAST(GRAPH_RESULT_DATA.TOTAL_07_SUM_CNT AS STRING), ',',
		        CAST(GRAPH_RESULT_DATA.TOTAL_08_SUM_CNT AS STRING), ',',
		        CAST(GRAPH_RESULT_DATA.TOTAL_17_SUM_CNT AS STRING), ',',
		        CAST(GRAPH_RESULT_DATA.TOTAL_18_SUM_CNT AS STRING), ',',
		        CAST(TIME_DATA_ARRAY_STRING AS STRING)
		    ) AS ALL_DATA_LIST
		FROM (
		    SELECT
		        GRAPH_DATA.STRSCT_DRCT_NM,
		        SUM(GRAPH_DATA.TOTAL_SUM_CNT) AS TOTAL_SUM_CNT,
		        SUM(CASE WHEN GRAPH_DATA.TIME_AM_OR_PM = '오전' THEN GRAPH_DATA.TOTAL_SUM_CNT ELSE 0 END) AS TOTAL_AM_SUM_CNT,
		        SUM(CASE WHEN GRAPH_DATA.TIME_AM_OR_PM = '오후' THEN GRAPH_DATA.TOTAL_SUM_CNT ELSE 0 END) AS TOTAL_PM_SUM_CNT,
		        SUM(CASE WHEN POSITION('07' IN GRAPH_DATA.TIME_SCTN_NM) > 0 THEN GRAPH_DATA.TOTAL_SUM_CNT ELSE 0 END) AS TOTAL_07_SUM_CNT,
		        SUM(CASE WHEN POSITION('08' IN GRAPH_DATA.TIME_SCTN_NM) > 0 AND POSITION('08' IN GRAPH_DATA.TIME_SCTN_NM) = 1 THEN GRAPH_DATA.TOTAL_SUM_CNT ELSE 0 END) AS TOTAL_08_SUM_CNT,
		        SUM(CASE WHEN POSITION('17' IN GRAPH_DATA.TIME_SCTN_NM) > 0 THEN GRAPH_DATA.TOTAL_SUM_CNT ELSE 0 END) AS TOTAL_17_SUM_CNT,
		        SUM(CASE WHEN POSITION('18' IN GRAPH_DATA.TIME_SCTN_NM) > 0 AND POSITION('18' IN GRAPH_DATA.TIME_SCTN_NM) = 1 THEN GRAPH_DATA.TOTAL_SUM_CNT ELSE 0 END) AS TOTAL_18_SUM_CNT,
		        CONCAT_WS(',', COLLECT_LIST(GRAPH_DATA.DATA_CNT_LIST)) AS TIME_DATA_ARRAY_STRING
		    FROM (
		        SELECT
		            TICT.STRSCT_NM,
		            TICT.STRSCT_DRCT_NM,
		            TICT.EXMN_NO,
		            TICT.STRSCT_DRCT_NO,
		            TICT.TIME_SCTN_NM,
		            TICT.TIME_AM_OR_PM,
		            SUM(TICT.PSGVHCL_TRFVLM + TICT.BUS_SMLSZ_TRFVLM + TICT.BUS_LRGSZ_TRFVLM + TICT.FRGHT_SMLSZ_TRFVLM + TICT.FRGHT_MDMSZ_TRFVLM + TICT.FRGHT_LRGSZ_TRFVLM) AS TOTAL_SUM_CNT,
		            concat_ws(',',CAST(SUM(TICT.PSGVHCL_TRFVLM) AS STRING), CAST(SUM(TICT.BUS_SMLSZ_TRFVLM) AS STRING), CAST(SUM(TICT.BUS_LRGSZ_TRFVLM) AS STRING), CAST(SUM(TICT.FRGHT_SMLSZ_TRFVLM) AS STRING), CAST(SUM(TICT.FRGHT_MDMSZ_TRFVLM) AS STRING), CAST(SUM(TICT.FRGHT_LRGSZ_TRFVLM) AS STRING)) AS DATA_CNT_LIST
		        FROM (
		            SELECT
		                STRSCT_NM,
		                STRSCT_DRCT_NM,
		                STRSCT_DRCT_NO,
		                EXMN_NO,
		                COALESCE(PSGVHCL_TRFVLM, 0) AS PSGVHCL_TRFVLM,
		                COALESCE(BUS_SMLSZ_TRFVLM, 0) AS BUS_SMLSZ_TRFVLM,
		                COALESCE(BUS_LRGSZ_TRFVLM, 0) AS BUS_LRGSZ_TRFVLM,
		                COALESCE(FRGHT_SMLSZ_TRFVLM, 0) AS FRGHT_SMLSZ_TRFVLM,
		                COALESCE(FRGHT_MDMSZ_TRFVLM, 0) AS FRGHT_MDMSZ_TRFVLM,
		                COALESCE(FRGHT_LRGSZ_TRFVLM, 0) AS FRGHT_LRGSZ_TRFVLM,
		                CASE
		                    WHEN POSITION('07' IN TIME_SCTN_NM) > 0 THEN '07:00~08:00'
		                    WHEN POSITION('08' IN TIME_SCTN_NM) > 0 AND POSITION('08' IN TIME_SCTN_NM) = 1 THEN '08:00~09:00'
		                    WHEN POSITION('17' IN TIME_SCTN_NM) > 0 THEN '17:00~18:00'
		                    WHEN POSITION('18' IN TIME_SCTN_NM) > 0 AND POSITION('18' IN TIME_SCTN_NM) = 1 THEN '18:00~19:00'
		                END AS TIME_SCTN_NM,
		                CASE
		                    WHEN POSITION('07' IN TIME_SCTN_NM) > 0 OR POSITION('08' IN TIME_SCTN_NM) > 0 THEN '오전'
		                    ELSE '오후'
		                END AS TIME_AM_OR_PM
		            FROM
		                GGITS.TRF_IPCSS_STRSCT_TRFVLM
		            WHERE
					IPCSS_MNG_NO = #{ipcssMngNo}
					AND DYWK_DIV = <choose>
										<when test="dywkDiv != null and dywkDiv != ''">
											#{dywkDiv}
										</when>
										<otherwise>
											'평일'
										</otherwise>
									</choose>
		           AND POSITION('~' IN TIME_SCTN_NM) > 0
		        ) TICT
		        GROUP BY TICT.STRSCT_NM, TICT.TIME_SCTN_NM, TICT.TIME_AM_OR_PM, TICT.EXMN_NO, TICT.STRSCT_DRCT_NM,TICT.STRSCT_DRCT_NO
		        ORDER BY TICT.TIME_SCTN_NM
		    ) GRAPH_DATA
		    GROUP BY GRAPH_DATA.STRSCT_DRCT_NM
		) GRAPH_RESULT_DATA
	</select>
</mapper>
