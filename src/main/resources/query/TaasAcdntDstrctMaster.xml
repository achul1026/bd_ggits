<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE mapper PUBLIC '-//mybatis.org//DTD Mapper 3.0//EN' 'http://mybatis.org/dtd/mybatis-3-mapper.dtd'>

<mapper namespace='com.neighbor21.ggits.common.mapper.TaasAcdntDstrctMasterMapper'>
    <sql id="columns">
        CLCT_DT
        ,ACDNT_DSTRCT_IDENTIFIER
         ,ACDNT_DSTRCT_ID
         ,ADSTDG_CD
         ,SUBSTRING(ADSTDG_CD,0,5) as sgg_cd
         ,POINT_CD
         ,ADSI_NM
         ,POINT_NM
         ,ACDNT_CNT
         ,CASLT_CNT
         ,DCSD_CNT
         ,SWPSN_CNT
         ,SINJPSN_CNT
         ,INJ_DCLR_CNT
         ,LON_CRDN
         ,LAT_CRDN
         /*,ACDNT_DSTRCT_PYN*/
    </sql>
    
    <sql id="commonWhere">
        <where>
            <!-- 연도별 검색 -->
            <if test="searchYear != null and searchYear != '' and searchYear != 'searchAllYear' ">
                and acdnt_dstrct_id LIKE #{searchYear}||'%'
            </if>
            <!-- 월별 검색 -->
            <if test="searchMonth != null and searchMonth != ''">
                and acdnt_dstrct_id LIKE #{searchYear}||#{searchMonth}||'%'
            </if>
            <if test="searchLocation != null and searchLocation != '' and searchLocation != 'searchAllLocation'">
                AND ADSTDG_CD LIKE CONCAT(substring(#{searchLocation}, 0 ,5),'%')
            </if>
        </where>
    </sql>
    
    <sql id="statsColumns">
		<choose>
			<when test="dataOption != null and dataOption == 'town'">
				ADSI_NM AS "adstdgNm"
			</when>
			<otherwise>
				(SELECT CD_NM FROM M_OP_CODE MOC WHERE GRP_CD_ID = 'SGG_CD' AND SUBSTRING(CD_ID,0,5) =  SUBSTRING(ADSTDG_CD, 0, 5)) AS "adstdgNm"
			</otherwise>
		</choose>
		,COALESCE(SUM(ACDNT_CNT),0) AS "acdntCnt"
    </sql>

    <sql id="statsWhere">
   		WHERE 1=1
   		<choose>
   			<when test="dataOption != null and dataOption == 'town'">
					AND ADSTDG_CD = substring(#{searchLocation}, 0, 5)
					AND ADSI_NM = #{searchLocationNm}
   			</when>
   			<otherwise>
		        <if test="searchLocation != null and searchLocation != '' and searchLocation != 'searchAllLocation'">
					AND SUBSTRING(ADSTDG_CD,0,5) LIKE CONCAT(substring(#{searchLocation}, 0 ,5),'%')
		        </if>
   			</otherwise>
   		</choose>
    </sql>

	<sql id="statsGroupBy">
		GROUP BY type,"adstdgNm"
	</sql>
    
    <select id="findAll" resultType="taasAcdntDstrctMaster" parameterType="mapBigdataSearchDTO">
        SELECT
        <include refid="columns"/>
        ,'BCYCL' AS TYPE
        FROM BIGDATA.EXT_taas_bcycl_acdnt_dstrct /* 자전거 사고 구역 */
        <include refid="commonWhere"/>
        UNION
        SELECT
        <include refid="columns"/>
        ,'JAYWK' AS TYPE
        FROM BIGDATA.EXT_taas_jaywk_pdst_acdnt_dstrct /*무단횡단 보행자 사고구역*/
        <include refid="commonWhere"/>
        UNION
        SELECT
        <include refid="columns"/>
        ,'LAWVLTN' AS TYPE
        FROM BIGDATA.EXT_taas_law_vltn_pdst_acdnt_dstrct /*법위반 보행자 사고구역*/
        <include refid="commonWhere"/>
        UNION
        SELECT
        <include refid="columns"/>
        ,'HLDY' AS TYPE
        FROM BIGDATA.EXT_taas_hldy_period_acdnt_dstrct /*휴일기간 보행자 사고구역*/
        <include refid="commonWhere"/>
        UNION
        SELECT
        <include refid="columns"/>
        ,'FROST' AS TYPE
        FROM BIGDATA.EXT_taas_frost_acdnt_dstrct /*결빙사고 구역*/
        <include refid="commonWhere"/>
        UNION
        SELECT
        <include refid="columns"/>
        ,'TWHLVH' AS TYPE
        FROM BIGDATA.EXT_taas_twhlvh_acdnt_dstrct /*이륜차 사고 구역*/
        <include refid="commonWhere"/>
        UNION
        SELECT
        <include refid="columns"/>
        ,'PDSN' AS TYPE
        FROM BIGDATA.EXT_taas_pdsn_acdnt_dstrct /*보행자 사고 구역*/
        <include refid="commonWhere"/>
        UNION
        SELECT
        <include refid="columns"/>
        ,'DRNKG' AS TYPE
        FROM BIGDATA.EXT_taas_drnkg_acdnt_dstrct /*음주 사고 구역*/
        <include refid="commonWhere"/>
        UNION
        SELECT
        CLCT_DT
        ,ACDNT_DSTRCT_IDENTIFIER
        ,ACDNT_DSTRCT_ID
        ,ADSTDG_CD
        ,SUBSTRING(ADSTDG_CD,0,5) as sgg_cd
        ,POINT_CD
        ,ADSI_NM
        ,POINT_NM
        ,ACDNT_CNT
        ,CASLT_CNT
        ,DCSD_CNT
        ,SWPSN_CNT
        ,SINJPSN_CNT
        ,INJ_DCLR_CNT
        ,LON_CRDN
        ,LAT_CRDN
        /*,ST_ASGEOJSON(ACDNT_DSTRCT_PYN) AS ACDNT_DSTRCT_PYN*/
        ,'TRUCK' AS TYPE
        FROM BIGDATA.EXT_taas_truck_acdnt_dstrct /*화물차 사고 구역*/
        <include refid="commonWhere"/>
        UNION
        SELECT
        <include refid="columns"/>
        ,'OLMAN' AS TYPE
        FROM BIGDATA.EXT_taas_pdst_olman_acdnt_dstrct /*노인 보행자 사고 구역*/
        <include refid="commonWhere"/>
        UNION
        SELECT
        <include refid="columns"/>
        ,'CHILD' AS TYPE
        FROM BIGDATA.ext_taas_pdst_chid_acdnt_dstrct /*어린이 보행자 사고 구역*/
        <include refid="commonWhere"/>
    </select>

    <select id="findAccidentCntAdstdgCd" resultType="map" parameterType="mapBigdataSearchDTO">
      	SELECT
			SUM(ACDNT_CNT) AS "acdntCnt"
      	<choose>
      		<when test="dataOption != null and dataOption == 'town'">
      			,ADSI_NM AS "adstdgNm"
				,ADSTDG_CD AS "adstdgCd"
      		</when>
      		<otherwise>
				,(SELECT CD_NM FROM M_OP_CODE MOC WHERE GRP_CD_ID = 'SGG_CD' AND SUBSTRING(CD_ID,0,5) =  SUBSTRING(ADSTDG_CD, 0, 5)) AS "adstdgNm"
				,SUBSTRING(ADSTDG_CD, 0, 5) as "adstdgCd"
      		</otherwise>
      	</choose>
		FROM
		(SELECT
        <include refid="columns"/>
        ,'BCYCL' AS TYPE
        FROM BIGDATA.EXT_taas_bcycl_acdnt_dstrct /* 자전거 사고 구역 */
        UNION
        SELECT
        <include refid="columns"/>
        ,'JAYWK' AS TYPE
        FROM BIGDATA.EXT_taas_jaywk_pdst_acdnt_dstrct /*무단횡단 보행자 사고구역*/
        UNION
        SELECT
        <include refid="columns"/>
        ,'LAWVLTN' AS TYPE
        FROM BIGDATA.EXT_taas_law_vltn_pdst_acdnt_dstrct /*법위반 보행자 사고구역*/
        UNION
        SELECT
        <include refid="columns"/>
        ,'HLDY' AS TYPE
        FROM BIGDATA.EXT_taas_hldy_period_acdnt_dstrct /*휴일기간 보행자 사고구역*/
        UNION
        SELECT
        <include refid="columns"/>
        ,'FROST' AS TYPE
        FROM BIGDATA.EXT_taas_frost_acdnt_dstrct /*결빙사고 구역*/
        UNION
        SELECT
        <include refid="columns"/>
        ,'TWHLVH' AS TYPE
        FROM BIGDATA.EXT_taas_twhlvh_acdnt_dstrct /*이륜차 사고 구역*/
        UNION
        SELECT
        <include refid="columns"/>
        ,'PDSN' AS TYPE
        FROM BIGDATA.EXT_taas_pdsn_acdnt_dstrct /*보행자 사고 구역*/
        UNION
        SELECT
        <include refid="columns"/>
        ,'DRNKG' AS TYPE
        FROM BIGDATA.EXT_taas_drnkg_acdnt_dstrct /*음주 사고 구역*/
        UNION
        SELECT
        CLCT_DT
        ,ACDNT_DSTRCT_IDENTIFIER
        ,ACDNT_DSTRCT_ID
        ,ADSTDG_CD
        ,POINT_CD
        ,ADSI_NM
        ,POINT_NM
        ,ACDNT_CNT
        ,CASLT_CNT
        ,DCSD_CNT
        ,SWPSN_CNT
        ,SINJPSN_CNT
        ,INJ_DCLR_CNT
        ,LON_CRDN
        ,LAT_CRDN
        /*,ST_ASGEOJSON(ACDNT_DSTRCT_PYN) AS ACDNT_DSTRCT_PYN*/
        ,'TRUCK' AS TYPE
        FROM BIGDATA.EXT_taas_truck_acdnt_dstrct /*화물차 사고 구역*/
        UNION
        SELECT
        <include refid="columns"/>
        ,'OLMAN' AS TYPE
        FROM BIGDATA.EXT_taas_pdst_olman_acdnt_dstrct /*노인 보행자 사고 구역*/
        UNION
        SELECT
        <include refid="columns"/>
        ,'CHILD' AS TYPE
        FROM BIGDATA.ext_taas_pdst_chid_acdnt_dstrct /*어린이 보행자 사고 구역*/
        ) C
	GROUP BY "adstdgNm" , "adstdgCd"
	ORDER BY "acdntCnt" DESC
	<if test="limit != null">
		LIMIT #{limit}
	</if>
      </select>

      <select id="findAcdntStatisticsByAdstdgCd" resultType="taasAcdntDstrctMaster" parameterType="mapBigdataSearchDTO">
     	SELECT
		<include refid="statsColumns"/>
		,'BCYCL' AS type
		FROM
          BIGDATA.EXT_TAAS_BCYCL_ACDNT_DSTRCT /* 자전거 사고 구역 */
			<include refid="statsWhere"/>
			<include refid="statsGroupBy"/>
		UNION
		SELECT
			<include refid="statsColumns"/>
			,'JAYWK' AS type
		FROM
          BIGDATA.EXT_TAAS_JAYWK_PDST_ACDNT_DSTRCT /*무단횡단 보행자 사고구역*/
			<include refid="statsWhere"/>
			<include refid="statsGroupBy"/>
		UNION
		SELECT
			<include refid="statsColumns"/>
			,'LAWVLTN' AS type
		FROM
          BIGDATA.EXT_TAAS_LAW_VLTN_PDST_ACDNT_DSTRCT /*법위반 보행자 사고구역*/
			<include refid="statsWhere"/>
			<include refid="statsGroupBy"/>
		UNION
		SELECT
			<include refid="statsColumns"/>
			,'HLDY' AS type
		FROM
          BIGDATA.EXT_TAAS_HLDY_PERIOD_ACDNT_DSTRCT /*휴일기간 보행자 사고구역*/
			<include refid="statsWhere"/>
			<include refid="statsGroupBy"/>
		UNION
		SELECT
			<include refid="statsColumns"/>
			, 'FROST' AS type
		FROM
          BIGDATA.EXT_TAAS_FROST_ACDNT_DSTRCT /*결빙사고 구역*/
			<include refid="statsWhere"/>
			<include refid="statsGroupBy"/>
		UNION
		SELECT
			<include refid="statsColumns"/>
			,'TWHLVH' AS type
		FROM
          BIGDATA.EXT_TAAS_TWHLVH_ACDNT_DSTRCT /*이륜차 사고 구역*/
			<include refid="statsWhere"/>
			<include refid="statsGroupBy"/>
		UNION
		SELECT
			<include refid="statsColumns"/>
			,'PDSN' AS type
		FROM
          BIGDATA.EXT_TAAS_PDSN_ACDNT_DSTRCT /*보행자 사고 구역*/
			<include refid="statsWhere"/>
			<include refid="statsGroupBy"/>
		UNION
		SELECT
			<include refid="statsColumns"/>
			,'DRNKG' AS type
		FROM
          BIGDATA.EXT_TAAS_DRNKG_ACDNT_DSTRCT /*음주 사고 구역*/
			<include refid="statsWhere"/>
			<include refid="statsGroupBy"/>
		UNION
		SELECT
			<include refid="statsColumns"/>
			,'TRUCK' AS type
		FROM
          BIGDATA.EXT_TAAS_TRUCK_ACDNT_DSTRCT /*화물차 사고 구역*/
			<include refid="statsWhere"/>
			<include refid="statsGroupBy"/>
		UNION
		SELECT
			<include refid="statsColumns"/>
			,'OLMAN' AS type
		FROM
          BIGDATA.EXT_TAAS_PDST_OLMAN_ACDNT_DSTRCT /*노인 보행자 사고 구역*/
			<include refid="statsWhere"/>
			<include refid="statsGroupBy"/>
          UNION
          SELECT
          <include refid="statsColumns"/>
          ,'CHILD' AS type
          FROM
          BIGDATA.ext_taas_pdst_chid_acdnt_dstrct /*어린이 보행자 사고 구역*/
          <include refid="statsWhere"/>
          <include refid="statsGroupBy"/>
      </select>

    <select id="findAllDataYears" resultType="map">
    	SELECT
            substring(acdnt_dstrct_id, 0, 5) AS "year"
        FROM BIGDATA.EXT_TAAS_BCYCL_ACDNT_DSTRCT /* 자전거 사고 구역 */
        GROUP BY substring(acdnt_dstrct_id, 0, 5)
        UNION
        SELECT
            substring(acdnt_dstrct_id, 0, 5) AS "year"
        FROM BIGDATA.EXT_TAAS_JAYWK_PDST_ACDNT_DSTRCT /*무단횡단 보행자 사고구역*/
        GROUP BY substring(acdnt_dstrct_id, 0, 5)
        UNION
        SELECT
            substring(acdnt_dstrct_id, 0, 5) AS "year"
        FROM BIGDATA.EXT_TAAS_LAW_VLTN_PDST_ACDNT_DSTRCT /*법위반 보행자 사고구역*/
        GROUP BY substring(acdnt_dstrct_id, 0, 5)
        UNION
        SELECT
            substring(acdnt_dstrct_id, 0, 5) AS "year"
        FROM BIGDATA.EXT_TAAS_HLDY_PERIOD_ACDNT_DSTRCT /*휴일기간 보행자 사고구역*/
        GROUP BY substring(acdnt_dstrct_id, 0, 5)
        UNION
        SELECT
            substring(acdnt_dstrct_id, 0, 5) AS "year"
        FROM BIGDATA.EXT_TAAS_FROST_ACDNT_DSTRCT /*결빙사고 구역*/
        GROUP BY substring(acdnt_dstrct_id, 0, 5)
        UNION
        SELECT
            substring(acdnt_dstrct_id, 0, 5) AS "year"
        FROM BIGDATA.EXT_TAAS_TWHLVH_ACDNT_DSTRCT /*이륜차 사고 구역*/
        GROUP BY substring(acdnt_dstrct_id, 0, 5)
        UNION
        SELECT
            substring(acdnt_dstrct_id, 0, 5) AS "year"
        FROM BIGDATA.EXT_TAAS_PDSN_ACDNT_DSTRCT /*보행자 사고 구역*/
        GROUP BY substring(acdnt_dstrct_id, 0, 5)
        UNION
        SELECT
            substring(acdnt_dstrct_id, 0, 5) AS "year"
        FROM BIGDATA.EXT_TAAS_DRNKG_ACDNT_DSTRCT /*음주 사고 구역*/
        GROUP BY substring(acdnt_dstrct_id, 0, 5)
        UNION
        SELECT
            substring(acdnt_dstrct_id, 0, 5) AS "year"
        FROM BIGDATA.EXT_TAAS_TRUCK_ACDNT_DSTRCT /*화물차 사고 구역*/
        GROUP BY substring(acdnt_dstrct_id, 0, 5)
        UNION
        SELECT
            substring(acdnt_dstrct_id, 0, 5) AS "year"
        FROM BIGDATA.EXT_TAAS_PDST_OLMAN_ACDNT_DSTRCT /*노인 보행자 사고 구역*/
        GROUP BY substring(acdnt_dstrct_id, 0, 5)
        ORDER BY YEAR DESC
        </select>
</mapper>
