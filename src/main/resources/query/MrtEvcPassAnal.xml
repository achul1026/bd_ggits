<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE mapper PUBLIC '-//mybatis.org//DTD Mapper 3.0//EN' 'http://mybatis.org/dtd/mybatis-3-mapper.dtd'>

<mapper namespace='com.neighbor21.ggits.common.mapper.MrtEvcPassAnalMapper'>

	<select id="findEmergencyPathAnalysis" parameterType="emergencyPathAnalysisRequest" resultType="emergencyPathAnalysisResponse">
		SELECT
			MNG_INST_CD,
			SRVC_ID,
			AVG_SRVC_TIME,
			AVG_SRVC_DSTNE,
			AVG_ARVL_PRNMNT_TIME,
			AVG_ARVL_PRNMNT_DSTNE
		FROM
			MRT_EVC_PASS_ANAL
		<trim prefix="WHERE" prefixOverrides="AND">
			<if test="mngInstCd != null and mngInstCd != ''">
				AND MNG_INST_CD = #{mngInstCd}
			</if>
			<if test="date != null and date != ''">
				AND ANLS_DT BETWEEN TO_TIMESTAMP(#{date}||' 00:00:00', 'YYYYMMDD HH24:MI:SS') 
				AND TO_TIMESTAMP(#{date}||' 23:59:59', 'YYYYMMDD HH24:MI:SS')
			</if>
			<if test="srvcId != null and srvcId != ''">
				AND SRVC_ID = #{srvcId}
			</if>
		</trim>
	</select>
	
	<select id="findEmergAcheivePtg" resultType="mrtEvcPassAnal">
		SELECT
			A.SERVICENAME AS EVNO,
			A.AVG_SRVC_TIME,
			A.AVG_ARVL_PRNMNT_TIME,
			A.DIFFERNCE_TIME,
			CASE WHEN DIFFERNCE_TIME > 0 THEN 'Y' ELSE 'N' END AS GOAL_YN
		FROM 
		(
			SELECT
				ANLS_DT,
				SRVC_ID,
				AVG_SRVC_TIME,
				AVG_ARVL_PRNMNT_TIME,
				AVG_ARVL_PRNMNT_TIME - AVG_SRVC_TIME AS DIFFERNCE_TIME,
				EVNO,
				SERVICENAME
			FROM
				MRT_EVC_PASS_ANAL MEPA
			INNER JOIN SCS_EMRG_VHCL_PATH_LOG SEVPL ON
				MEPA.SRVC_ID = SEVPL.SERVICEID
			WHERE
				ANLS_DT > CURRENT_DATE+INTERVAL '-1 DAY'
			ORDER BY ANLS_DT
		) A
		ORDER BY A.ANLS_DT
		LIMIT 10
	</select>
	
	
			
	<select id="findEmergAcheivePtgV2" resultType="mrtEvcPassAnal">
		SELECT
			A.SERVICENAME AS EVNO,
		 	A.AVG_SRVC_TIME AS AVG_SRVC_TIME,
			ROUND(EXTRACT(DAY    FROM A.PREDICTED_ARRIVAL_DATE - A.ARRIVAL_DATE) *24*60*60
		     + EXTRACT(HOUR   FROM A.PREDICTED_ARRIVAL_DATE - A.ARRIVAL_DATE) *60*60
		     + EXTRACT(MINUTE FROM A.PREDICTED_ARRIVAL_DATE - A.ARRIVAL_DATE) *60
		     + EXTRACT(SECOND FROM A.PREDICTED_ARRIVAL_DATE - A.ARRIVAL_DATE)) AS DIFFERNCE_TIME,
		 	ROUND(EXTRACT(DAY    FROM A.PREDICTED_ARRIVAL_DATE - A.START_DATE) *24*60*60
		     + EXTRACT(HOUR   FROM A.PREDICTED_ARRIVAL_DATE - A.START_DATE) *60*60
		     + EXTRACT(MINUTE FROM A.PREDICTED_ARRIVAL_DATE - A.START_DATE) *60
		     + EXTRACT(SECOND FROM A.PREDICTED_ARRIVAL_DATE - A.START_DATE)) AS AVG_ARVL_PRNMNT_TIME,
		    SEVMI.FIRENAME 
			FROM
				(WITH 
					EMRG_CUR_INFO_CHK 
				AS (
					SELECT 
							COUNT(SEVCI.SERVICEID) AS CUR_INF_CNT,
							SEVCI.SERVICEID
					FROM SCS_EMRG_VHCL_CUR_INFO SEVCI
					GROUP BY SEVCI.SERVICEID 
				)
				SELECT 
						EMRG_INFO.EVNO, 
						EMRG_INFO.SERVICEID, 
						EMRG_INFO.START_DATE,
						EMRG_INFO.SERVICENAME,
						EMRG_INFO.PREDICTED_ARRIVAL_DATE,
						EMRG_INFO.ARRIVAL_DATE, 
						EMRG_INFO.ARRIVALTIME_FORMAT,
					 ROUND(EXTRACT(DAY    FROM EMRG_INFO.ARRIVAL_DATE - EMRG_INFO.START_DATE) *24*60*60
					     + EXTRACT(HOUR   FROM EMRG_INFO.ARRIVAL_DATE - EMRG_INFO.START_DATE) *60*60
					     + EXTRACT(MINUTE FROM EMRG_INFO.ARRIVAL_DATE - EMRG_INFO.START_DATE) *60
					     + EXTRACT(SECOND FROM EMRG_INFO.ARRIVAL_DATE - EMRG_INFO.START_DATE)) AS AVG_SRVC_TIME,
						DATE_PART('MINUTE',EMRG_INFO.PREDICTED_ARRIVAL_DATE - EMRG_INFO.ARRIVAL_DATE)||'분'||ROUND(DATE_PART('SECOND',EMRG_INFO.PREDICTED_ARRIVAL_DATE - EMRG_INFO.ARRIVAL_DATE)::NUMERIC)||'초'AS TIME_DIFFERENCE,
						EMRG_LOG.CURRENTLAT ,
						EMRG_LOG.CURRENTLNG ,
						CASE WHEN  COALESCE(EMRG_CUR_INFO_CHK.CUR_INF_CNT,0) = 0 THEN 'CUS001' ELSE 'CUS002' END AS EMRG_CUR_STTS_CD
				FROM (
						SELECT
							   SEVPI.EVNO,
							   SEVPI.SERVICEID ,
								SEVPI.SERVICENAME,
							   MAX(SEVLI.COLLECTDT)  AS ARRIVAL_DATE,
							   MIN(SEVLI.COLLECTDT)  AS START_DATE,
							   MIN(SEVLI.COLLECTDT)  + MAX(SEVPI.ARRIVALTIME) * INTERVAL '1 SECOND' AS PREDICTED_ARRIVAL_DATE,
							  <![CDATA[
								CASE WHEN MAX(SEVPI.ARRIVALTIME) >= 3600 THEN TO_CHAR(MAX(SEVPI.ARRIVALTIME) * INTERVAL '1 SECOND', 'HH24시 MI분 SS초')
									 WHEN (MAX(SEVPI.ARRIVALTIME) < 3600 AND MAX(SEVPI.ARRIVALTIME) > 60) THEN  TO_CHAR(MAX(SEVPI.ARRIVALTIME) * INTERVAL '1 SECOND', 'MI분 SS초')
									 WHEN MAX(SEVPI.ARRIVALTIME) <= 60 THEN  TO_CHAR(MAX(SEVPI.ARRIVALTIME) * INTERVAL '1 SECOND', 'SS초')
									 ELSE '0'
									 END
							]]>
								AS ARRIVALTIME_FORMAT
						FROM
							(SELECT
				MAX(SEVPL.COLLECTDT)
				,SEVPL.SERVICEID
				,SEVPL.EVNO
				,SEVPL.CURRENTLAT
				,SEVPL.CURRENTLNG
				,SEVPL.SERVICENAME
				,SEVPL.ARRIVALLAT
				,SEVPL.ARRIVALLNG
				,SEVPL.ROUTE
				,SEVPL.VEHICLELENGTH
				,SEVPL.OCRNO
				,SEVPL.OCRTYPE
				,SEVPL.ARRIVALTIME
				FROM SCS_EMRG_VHCL_PATH_LOG SEVPL
				GROUP BY
				SEVPL.SERVICEID
				,SEVPL.EVNO
				,SEVPL.CURRENTLAT
				,SEVPL.CURRENTLNG
				,SEVPL.SERVICENAME
				,SEVPL.ARRIVALLAT
				,SEVPL.ARRIVALLNG
				,SEVPL.ROUTE
				,SEVPL.VEHICLELENGTH
				,SEVPL.OCRNO
				,SEVPL.OCRTYPE
				,SEVPL.ARRIVALTIME) SEVPI
						INNER JOIN
							SCS_EMRG_VHCL_LOG_INFO SEVLI ON SEVPI.SERVICEID = SEVLI.SERVICEID
						LEFT JOIN SCS_EMRG_VHCL_CUR_INFO SEVCI ON SEVPI.SERVICEID = SEVCI.SERVICEID
						GROUP BY 	SEVPI.EVNO,
									SEVPI.SERVICEID,
									SEVPI.SERVICENAME
				)EMRG_INFO			
			LEFT JOIN
				 SCS_EMRG_VHCL_LOG_INFO EMRG_LOG ON EMRG_INFO.SERVICEID = EMRG_LOG.SERVICEID AND EMRG_LOG.COLLECTDT = EMRG_INFO.ARRIVAL_DATE
			LEFT JOIN  EMRG_CUR_INFO_CHK ON EMRG_CUR_INFO_CHK.SERVICEID = EMRG_INFO.SERVICEID
			WHERE
				EMRG_LOG.COLLECTDT > CURRENT_DATE
			ORDER BY EMRG_INFO.START_DATE DESC ) A
			INNER JOIN SCS_EMRG_VHCL_MST_INFO SEVMI ON A.EVNO = SEVMI.EVNO 
			WHERE AVG_SRVC_TIME > 5
			ORDER BY A.START_DATE DESC
			LIMIT 10
	</select>
	
	<select id="findAvgDifferentTimeForToday" resultType="int">
		SELECT
			COALESCE (ROUND(AVG(EXTRACT(DAY    FROM A.PREDICTED_ARRIVAL_DATE - A.ARRIVAL_DATE) *24*60*60
		     + EXTRACT(HOUR   FROM A.PREDICTED_ARRIVAL_DATE - A.ARRIVAL_DATE) *60*60
		     + EXTRACT(MINUTE FROM A.PREDICTED_ARRIVAL_DATE - A.ARRIVAL_DATE) *60
		     + EXTRACT(SECOND FROM A.PREDICTED_ARRIVAL_DATE - A.ARRIVAL_DATE))),0) AS DIFFERNCE_TIME_AVG
			FROM
				(WITH 
					EMRG_CUR_INFO_CHK 
				AS (
					SELECT 
							COUNT(SEVCI.SERVICEID) AS CUR_INF_CNT,
							SEVCI.SERVICEID
					FROM SCS_EMRG_VHCL_CUR_INFO SEVCI
					GROUP BY SEVCI.SERVICEID 
				)
				SELECT 
						EMRG_INFO.EVNO, 
						EMRG_INFO.SERVICEID, 
						EMRG_INFO.START_DATE,
						EMRG_INFO.SERVICENAME,
						EMRG_INFO.PREDICTED_ARRIVAL_DATE,
						EMRG_INFO.ARRIVAL_DATE, 
						EMRG_INFO.ARRIVALTIME_FORMAT, 
						ROUND(EXTRACT(DAY    FROM EMRG_INFO.ARRIVAL_DATE - EMRG_INFO.START_DATE) *24*60*60
					     + EXTRACT(HOUR   FROM EMRG_INFO.ARRIVAL_DATE - EMRG_INFO.START_DATE) *60*60
					     + EXTRACT(MINUTE FROM EMRG_INFO.ARRIVAL_DATE - EMRG_INFO.START_DATE) *60
					     + EXTRACT(SECOND FROM EMRG_INFO.ARRIVAL_DATE - EMRG_INFO.START_DATE)) AS AVG_SRVC_TIME,
						DATE_PART('MINUTE',EMRG_INFO.PREDICTED_ARRIVAL_DATE - EMRG_INFO.ARRIVAL_DATE)||'분'||ROUND(DATE_PART('SECOND',EMRG_INFO.PREDICTED_ARRIVAL_DATE - EMRG_INFO.ARRIVAL_DATE)::NUMERIC)||'초'AS TIME_DIFFERENCE,
						EMRG_LOG.CURRENTLAT ,
						EMRG_LOG.CURRENTLNG ,
						CASE WHEN  COALESCE(EMRG_CUR_INFO_CHK.CUR_INF_CNT,0) = 0 THEN 'CUS001' ELSE 'CUS002' END AS EMRG_CUR_STTS_CD
				FROM (
						SELECT
							   SEVPI.EVNO,
							   SEVPI.SERVICEID ,
								SEVPI.SERVICENAME,
							   MAX(SEVLI.COLLECTDT)  AS ARRIVAL_DATE,
							   MIN(SEVLI.COLLECTDT)  AS START_DATE,
							   MIN(SEVLI.COLLECTDT)  + MAX(SEVPI.ARRIVALTIME) * INTERVAL '1 SECOND' AS PREDICTED_ARRIVAL_DATE,
						<![CDATA[
							   CASE WHEN MAX(SEVPI.ARRIVALTIME) >= 3600 THEN TO_CHAR(MAX(SEVPI.ARRIVALTIME) * INTERVAL '1 SECOND', 'HH24시 MI분 SS초')
									 WHEN (MAX(SEVPI.ARRIVALTIME) < 3600 AND MAX(SEVPI.ARRIVALTIME) > 60) THEN  TO_CHAR(MAX(SEVPI.ARRIVALTIME) * INTERVAL '1 SECOND', 'MI분 SS초')
									 WHEN MAX(SEVPI.ARRIVALTIME) <= 60 THEN  TO_CHAR(MAX(SEVPI.ARRIVALTIME) * INTERVAL '1 SECOND', 'SS초')
									 ELSE '0'
									 END
						]]>
								AS ARRIVALTIME_FORMAT
						FROM
							(SELECT
				MAX(SEVPL.COLLECTDT)
				,SEVPL.SERVICEID
				,SEVPL.EVNO
				,SEVPL.CURRENTLAT
				,SEVPL.CURRENTLNG
				,SEVPL.SERVICENAME
				,SEVPL.ARRIVALLAT
				,SEVPL.ARRIVALLNG
				,SEVPL.ROUTE
				,SEVPL.VEHICLELENGTH
				,SEVPL.OCRNO
				,SEVPL.OCRTYPE
				,SEVPL.ARRIVALTIME
				FROM SCS_EMRG_VHCL_PATH_LOG SEVPL
				GROUP BY
				SEVPL.SERVICEID
				,SEVPL.EVNO
				,SEVPL.CURRENTLAT
				,SEVPL.CURRENTLNG
				,SEVPL.SERVICENAME
				,SEVPL.ARRIVALLAT
				,SEVPL.ARRIVALLNG
				,SEVPL.ROUTE
				,SEVPL.VEHICLELENGTH
				,SEVPL.OCRNO
				,SEVPL.OCRTYPE
				,SEVPL.ARRIVALTIME) SEVPI
						INNER JOIN
							SCS_EMRG_VHCL_LOG_INFO SEVLI ON SEVPI.SERVICEID = SEVLI.SERVICEID
						LEFT JOIN SCS_EMRG_VHCL_CUR_INFO SEVCI ON SEVPI.SERVICEID = SEVCI.SERVICEID
						GROUP BY 	SEVPI.EVNO,
									SEVPI.SERVICEID,
									SEVPI.SERVICENAME
				)EMRG_INFO			
			LEFT JOIN
				 SCS_EMRG_VHCL_LOG_INFO EMRG_LOG ON EMRG_INFO.SERVICEID = EMRG_LOG.SERVICEID AND EMRG_LOG.COLLECTDT = EMRG_INFO.ARRIVAL_DATE
			LEFT JOIN  EMRG_CUR_INFO_CHK ON EMRG_CUR_INFO_CHK.SERVICEID = EMRG_INFO.SERVICEID
			WHERE
				EMRG_LOG.COLLECTDT > CURRENT_DATE
			ORDER BY EMRG_INFO.START_DATE DESC ) A 
			WHERE AVG_SRVC_TIME > 5
	</select>
</mapper>
