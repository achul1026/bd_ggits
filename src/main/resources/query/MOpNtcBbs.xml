<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE mapper PUBLIC '-//mybatis.org//DTD Mapper 3.0//EN' 'http://mybatis.org/dtd/mybatis-3-mapper.dtd'>

<mapper namespace='com.neighbor21.ggits.common.mapper.MOpNtcBbsMapper'>

	<insert id="saveMOpNtcBbs" parameterType="mOpNtcBbs">
		INSERT INTO M_OP_NTC_BBS (
			NTC_ID,
			OPRTR_ID,
			NTC_TITLE,
			NTC_CNTS,
			NTC_CRT_DT,
			NTC_UPDT_DT,
			NTC_SRCH_CNT,
			ATCH_FILE_YN,
			ATCH_FILE_NM,
			ATCH_FILE_ORG_NM,
			ATCH_FILE_PATH,
			ATCH_FILE_SIZE
		) VALUES ( 
			#{ntcId},
			#{oprtrId},
			#{ntcTitle},
			#{ntcCnts},
			NOW(),
			NOW(),
			#{ntcSrchCnt},
			#{atchFileYn},
			#{atchFileNm},
			#{atchFileOrgNm},
			#{atchFilePath},
			#{atchFileSize}
		)
	</insert>
	
	<select id="findMOpNtcBbsBySearchOption" resultType="mOpNtcBbs" parameterType="mOpNtcBbs">
		SELECT 
			ROW_NUMBER() OVER(ORDER BY MONB.NTC_CRT_DT) AS ROWNUM,
			MONB.NTC_ID,
			MONB.OPRTR_ID,
			MONB.NTC_TITLE,
			MONB.NTC_CNTS,
			MONB.NTC_CRT_DT,
			MONB.NTC_SRCH_CNT,
			MONB.ATCH_FILE_YN,
			MOO.OPRTR_NM
		FROM M_OP_NTC_BBS MONB
		INNER JOIN M_OP_OPERATOR MOO ON MONB.OPRTR_ID = MOO.OPRTR_ID
		<where>
			<if test="strDt != null and strDt != ''">
			<![CDATA[
			   AND MONB.NTC_CRT_DT >= TO_TIMESTAMP(#{strDt},'YYYY-MM-DD HH24:mi:ss') 
			]]>
			</if>
			<if test="endDt != null and endDt != ''">
			<![CDATA[
			   AND MONB.NTC_CRT_DT <= TO_TIMESTAMP(#{endDt},'YYYY-MM-DD HH24:mi:ss')
			]]>
			</if>
			<choose>
				<when test="ntcTitle != null and ntcTitle != '' and ntcCnts != null and ntcCnts != ''">
					AND (MONB.NTC_TITLE LIKE '%' || #{ntcTitle} || '%'
					OR MONB.NTC_CNTS LIKE '%' || #{ntcCnts} || '%')
				</when>
				<otherwise>
					<if test="ntcTitle != null and ntcTitle != ''">
						AND MONB.NTC_TITLE LIKE '%' || #{ntcTitle} || '%'
					</if>
				</otherwise>
			</choose>
			<if test="oprtrNm != null and oprtrNm != ''">
				AND MOO.OPRTRNM LIKE '%' || #{oprtrNm} || '%'
			</if>
		</where>
		ORDER BY ROWNUM DESC 
		LIMIT 10 OFFSET (#{page} - 1) * 10
	</select>

	<select id="countBySearchOption" resultType="Long" parameterType="mOpNtcBbs">
		SELECT 
			COUNT(*)
		FROM M_OP_NTC_BBS MONB
		INNER JOIN M_OP_OPERATOR MOO ON MONB.OPRTR_ID = MOO.OPRTR_ID
		<where>
			<if test="strDt != null and strDt != ''">
			<![CDATA[
			   AND MONB.NTC_CRT_DT >= TO_TIMESTAMP(#{strDt},'YYYY-MM-DD HH24:mi:ss') 
			]]>
			</if>
			<if test="endDt != null and endDt != ''">
			<![CDATA[
			   AND MONB.NTC_CRT_DT <= TO_TIMESTAMP(#{endDt},'YYYY-MM-DD HH24:mi:ss')
			]]>
			</if>
			<choose>
				<when test="ntcTitle != null and ntcTitle != '' and ntcCnts != null and ntcCnts != ''">
					AND (MONB.NTC_TITLE LIKE '%' || #{ntcTitle} || '%'
					OR MONB.NTC_CNTS LIKE '%' || #{ntcCnts} || '%')
				</when>
				<otherwise>
					<if test="ntcTitle != null and ntcTitle != ''">
						AND MONB.NTC_TITLE LIKE '%' || #{ntcTitle} || '%'
					</if>
				</otherwise>
			</choose>
			<if test="oprtrNm != null and oprtrNm != ''">
				AND MOO.OPRTRNM LIKE '%' || #{oprtrNm} || '%'
			</if>
		</where>
	</select>
	
	<select id="findOneByNtcId" resultType="mOpNtcBbs" parameterType="String">
		SELECT 
			NTC_ID,
			OPRTR_ID,
			NTC_TITLE,
			NTC_CNTS,
			NTC_CRT_DT,
			NTC_UPDT_DT,
			NTC_SRCH_CNT,
			ATCH_FILE_YN,
			ATCH_FILE_NM,
			ATCH_FILE_ORG_NM,
			ATCH_FILE_PATH,
			ATCH_FILE_SIZE
		FROM M_OP_NTC_BBS
		WHERE NTC_ID = #{ntcId}
	</select>
	
	<update id="updateMOpNtcBbs" parameterType="mOpNtcBbs">
		UPDATE M_OP_NTC_BBS SET
		 	NTC_TITLE = #{ntcTitle},
		 	NTC_CNTS = #{ntcCnts},
		 	NTC_UPDT_DT = NOW()
		 	<if test="atchFileYn != null and atchFileYn = ''">
				,ATCH_FILE_YN = #{atchFileYn}
				,ATCH_FILE_NM = #{atchFileNm}
				,ATCH_FILE_ORG_NM = #{atchFileOrgNm}
				,ATCH_FILE_PATH = #{atchFilePath}
				,ATCH_FILE_SIZE = #{atchFileSize}
		 	</if>
		WHERE NTC_ID = #{ntcId}
	</update>
	
	<select id="findntcSrchCntByNtcId" resultType="Long" parameterType="String">
		SELECT 
			COALESCE (NTC_SRCH_CNT , 0) AS NTC_SRCH_CNT
		FROM M_OP_NTC_BBS
		WHERE NTC_ID = #{ntcId}
	</select>

	<update id="updateNtcSrchCnt" parameterType="mOpNtcBbs">
		UPDATE M_OP_NTC_BBS SET
		 	NTC_SRCH_CNT = NTC_SRCH_CNT+1
		WHERE NTC_ID = #{ntcId}
	</update>
	
	<delete id="deleteMOpNtcBbs" parameterType="String">
		DELETE FROM M_OP_NTC_BBS
		WHERE NTC_ID = #{ntcId}
	</delete>
	
</mapper>
