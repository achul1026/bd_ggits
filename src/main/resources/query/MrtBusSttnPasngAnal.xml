<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.neighbor21.ggits.common.mapper.MrtBusSttnPasngAnalMapper">
	<sql id="mrtBusSttnPasngAnal-Where">
		<if test="(strDt != '' and strDt != '') and (endDt != '' and endDt != null)">
			AND TO_TIMESTAMP(mbspa.RIDE_YMD,'YYYYMMDD') 
			BETWEEN TO_TIMESTAMP(#{strDt}, 'YYYY-MM-DD') 
		    	AND TO_TIMESTAMP(#{endDt}, 'YYYY-MM-DD')
		</if>
		<if test="(strDt != '' and strDt != null) and (endDt == '' or endDt == null)">
			<![CDATA[
			AND TO_TIMESTAMP(#{strDt}, 'YYYY-MM-DD')  <= TO_TIMESTAMP(mbspa.RIDE_YMD,'YYYYMMDD') 
			]]>
		</if>
		<if test="(strDt == '' or strDt == null) and (endDt != '' and endDt != null)">
			<![CDATA[
			AND TO_TIMESTAMP(mbspa.RIDE_YMD,'YYYYMMDD')  <= TO_TIMESTAMP(#{endDt}, 'YYYY-MM-DD')
			]]>
		</if>
		<if test="searchContent != null and searchContent != ''">
			AND gbs.STATION_NM LIKE '%' || #{searchContent} || '%' 
		</if>
		<if test="sigunCdId != null and sigunCdId != '' and sigunCdId != 'searchAllLocation'">
			AND SUBSTRING(gbs.SIDO_CD,0,6) = #{sigunCdId}
		</if>
		<if test="dayOfTheWeek != null">
			AND EXTRACT (ISODOW from TO_TIMESTAMP(mbspa.RIDE_YMD,'YYYYMMDD'))::varchar(1) IN 
				<foreach collection="dayOfTheWeek" item="item" index="index" separator="," open="(" close=")">
                    #{item}
                </foreach>
		</if>
	</sql>
	
	<select id="countBusSttnPasngList" parameterType="commonEntity" resultType="int">
		SELECT	
			COUNT(mbspa.*)
		FROM
			MRT_BUS_STTN_PASNG_ANAL mbspa
		INNER JOIN BIGDATA.EXT_GGBIS_BUS_STATION gbs
			ON mbspa.BSTP_ID = gbs.STATION_ID
		WHERE
			1=1
			<include refid="mrtBusSttnPasngAnal-Where"/>
	</select>
	<select id="findAllBusSttnPasngList" parameterType="commonEntity" resultType="mrtBusSttnPasngAnal">
		SELECT	
			gbs.STATION_NM as BSTP_NM
			, mbspa.RIDE_USER_CNT
			, mbspa.LNDI_USER_CNT
			, mbspa.TRNSIT_USER_CNT
			, (mbspa.RIDE_USER_CNT - mbspa.LNDI_USER_CNT + mbspa.TRNSIT_USER_CNT) as sumPasng
			, to_char(to_timestamp(mbspa.RIDE_YMD, 'YYYYMMDD'),'YYYY-MM-DD') as RIDE_YMD
		FROM
			MRT_BUS_STTN_PASNG_ANAL mbspa
		INNER JOIN BIGDATA.EXT_GGBIS_BUS_STATION gbs
			ON mbspa.BSTP_ID = gbs.STATION_ID
		WHERE
			1=1
			<include refid="mrtBusSttnPasngAnal-Where"/>
		ORDER BY TO_TIMESTAMP(mbspa.RIDE_YMD, 'YYYYMMDD') DESC
		LIMIT 10 OFFSET (#{page} - 1) * 10;
	</select>
	
	<select id="findAllDataYears" resultType="map">
		SELECT
			TO_CHAR(TO_DATE(RIDE_YMD, 'YYYYMMDD'),'YYYY') AS "year"
		FROM
			MRT_BUS_STTN_PASNG_ANAL
		GROUP BY TO_CHAR(TO_DATE(RIDE_YMD, 'YYYYMMDD'),'YYYY')
		ORDER BY TO_CHAR(TO_DATE(RIDE_YMD, 'YYYYMMDD'),'YYYY') DESC  
	</select>

	<select id="findAllGroupBySGG" parameterType="mapBigdataSearchDTO" resultType="mrtBusSttnPasngAnal">
		SELECT
			SUM(MBSPA.TRNSIT_USER_CNT) AS "TRNSIT_USER_CNT" -- 환승수
			 ,SUM(MBSPA.RIDE_USER_CNT) AS "RIDE_USER_CNT" -- 승객수
			 ,SUM(MBSPA.LNDI_USER_CNT) AS "LNDI_USER_CNT" -- 버스 사용자수
			 ,GBS.SIDO_CD
		FROM MRT_BUS_STTN_PASNG_ANAL MBSPA
			 INNER JOIN BIGDATA.EXT_GGBIS_BUS_STATION GBS ON MBSPA.BSTP_ID = GBS.STATION_ID -- 승차정류장,하차정류장
		 where
		 1=1
		<!-- 연도별 검색 -->
		<if test="searchYear != null and searchYear != '' and searchYear != 'searchAllYear' ">
			AND TO_CHAR(TO_DATE(mbspa.ride_ymd,'YYYYMMDD'), 'YYYY') = #{searchYear}
		</if>
		<!-- 기간 검색 -->
		<if test="searchPeriod != null and searchPeriod != ''">
			<choose>
				<when test="searchPeriod == 'weekday' ">
					AND TO_CHAR(TO_DATE(mbspa.ride_ymd, 'YYYYMMDD'), 'D') BETWEEN '2' AND '6'
				</when>
				<when test="searchPeriod == 'weekend' ">
					AND (TO_CHAR(TO_DATE(mbspa.ride_ymd, 'YYYYMMDD'), 'D') = '1' OR TO_CHAR(TO_DATE(mbspa.ride_ymd, 'YYYYMMDD'), 'D') = '7')
				</when>
				<otherwise>
					AND TO_CHAR(TO_DATE(mbspa.ride_ymd, 'YYYYMMDD'), 'YYYY-MM-DD') BETWEEN #{startDate} AND #{endDate}
				</otherwise>
			</choose>
		</if>
		<if test="sigunCdId != null and sigunCdId != '' and sigunCdId != 'searchAllLocation'">
			AND GBS.SIDO_CD LIKE CONCAT(#{sigunCdId},'%')
		</if>
		GROUP BY
		GBS.SIDO_CD
	</select>
</mapper>