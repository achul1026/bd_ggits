<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE mapper PUBLIC '-//mybatis.org//DTD Mapper 3.0//EN' 'http://mybatis.org/dtd/mybatis-3-mapper.dtd'>

<mapper namespace='com.neighbor21.ggits.common.mapper.AdsiSmcrsrdCrsrdInfoMapper'>

	<select id="findAllOneHourStats" resultType="adsiSmcrsrdCrsrdInfo" parameterType="String">
		SELECT
			ASCI.MNG_INST_CD
			 ,ASCI.CRSRD_ID
			 ,ASCI.CRSRD_NM
			 ,ASCI.NODE_ID
			 ,ASCI.LON_CRDN
			 ,ASCI.LAT_CRDN
			 ,ASCI.MAX_TRFVLM
			 ,ASCI.MAX_PDST_CNT
			 ,GCIN.NODE_NAME
			 ,ST_X(GCIN.GEOMETRY)
			 ,ST_Y(GCIN.GEOMETRY)
			 ,ST_ASGEOJSON(GCIN.GEOMETRY) AS GEOJSON
			 ,SUM(ascarsfc.vhcl_trfvlm) AS VHCL_TRFVLM
			 ,SUM(ascarsfc.PDST_CNT) AS PDST_CNT
			 ,AVG(ascarsfc.AVG_VHCL_SPEED) AS AVG_VHCL_SPEED
			 ,AVG(ascarsfc.AVG_PDST_SPEED) AS AVG_PDST_SPEED
		FROM
			BIGDATA.EXT_ADSI_SMCRSRD_CRSRD_INFO ASCI
				LEFT JOIN C_GM_STD_NODE GCIN ON ASCI.NODE_ID = GCIN.NODE_ID
				LEFT JOIN (
				select
					*
				from
					adsi_smcrsrd_crsrd_acs_road_stats_fivmin_cur ascarsfc
				where
					ascarsfc.clct_dt >= now() - interval '1 hour'
			)
				ascarsfc on asci.crsrd_id = ascarsfc.crsrd_id and asci.mng_inst_cd = ascarsfc.mng_inst_cd
		<where>
			<if test="mngInstCd != null and mngInstCd != ''">
				ASCI.MNG_INST_CD = #{mngInstCd}
			</if>
		</where>
		GROUP BY ASCI.MNG_INST_CD,ASCI.CRSRD_ID,ASCI.CRSRD_NM,ASCI.NODE_ID,ASCI.LON_CRDN	 ,ASCI.LAT_CRDN,ASCI.MAX_TRFVLM,ASCI.MAX_PDST_CNT,GCIN.NODE_NAME,ST_X(GCIN.GEOMETRY),ST_Y(GCIN.GEOMETRY),GEOJSON
	</select>
    <select id="findAll" resultType="adsiSmcrsrdCrsrdInfo">
		SELECT
			ASCI.MNG_INST_CD
			 ,ASCI.CRSRD_ID
			 ,ASCI.CRSRD_NM
			 ,ASCI.NODE_ID
			 ,ASCI.LON_CRDN
			 ,ASCI.LAT_CRDN
			 ,ASCI.MAX_TRFVLM
			 ,ASCI.MAX_PDST_CNT
			 ,GCIN.NODE_NAME
			 ,ST_X(GCIN.GEOMETRY)
			 ,ST_Y(GCIN.GEOMETRY)
			 ,ST_ASGEOJSON(GCIN.GEOMETRY) AS GEOJSON
		FROM
			BIGDATA.EXT_ADSI_SMCRSRD_CRSRD_INFO ASCI
				INNER JOIN (
				SELECT MAX(ASCI.ETL_DT) AS RCT_ETL_DT
					 , ASCI.CRSRD_ID
					 , ASCI.MNG_INST_CD
				FROM BIGDATA.EXT_ADSI_SMCRSRD_CRSRD_INFO ASCI
				GROUP BY MNG_INST_CD, CRSRD_ID
			) RCT_ASCI ON RCT_ASCI.MNG_INST_CD = ASCI.MNG_INST_CD and RCT_ASCI.CRSRD_ID = asci.CRSRD_ID AND RCT_ASCI.RCT_ETL_DT = ASCI.ETL_DT
				INNER JOIN C_GM_STD_NODE GCIN ON ASCI.NODE_ID = GCIN.NODE_ID
    </select>
    
    
    <select id="findAllSmartForFacility" parameterType="mapFacilityMenuDTO" resultType="mapFacilityMenuDTO">
		SELECT
				ASCI.CRSRD_NM							AS "name",
				ASCI.CRSRD_ID							AS "id",
				ASCI.NODE_ID							AS "nodeId",
				ASCI.LON_CRDN							AS "lon",
			 	ASCI.LAT_CRDN							AS "lat"
		FROM BIGDATA.EXT_ADSI_SMCRSRD_CRSRD_INFO ASCI
		INNER JOIN (
		SELECT MAX(ASCI.ETL_DT) AS RCT_ETL_DT
		, ASCI.CRSRD_ID
		, ASCI.MNG_INST_CD
		FROM BIGDATA.EXT_ADSI_SMCRSRD_CRSRD_INFO ASCI
		GROUP BY MNG_INST_CD, CRSRD_ID
		) RCT_ASCI ON RCT_ASCI.MNG_INST_CD = ASCI.MNG_INST_CD and RCT_ASCI.CRSRD_ID = asci.CRSRD_ID AND RCT_ASCI.RCT_ETL_DT = ASCI.ETL_DT
		WHERE 
				1=1
			<if test="name != null and name != ''">
				AND ASCI.CRSRD_NM LIKE '%' || #{name} || '%'
			</if>  
			<if test="id != null and id != ''">
				AND ASCI.CRSRD_ID = #{id}
			</if>  
		ORDER BY ASCI.CRSRD_ID DESC
		<if test="page != null and page != '' and page != 0 ">
		LIMIT 5 OFFSET (#{page} - 1) * 5  	
		</if> 				
	</select>
	
	<select id="countSmartForFacility" parameterType="mapFacilityMenuDTO" resultType="int">
		SELECT
				COUNT(*)
		FROM 	BIGDATA.EXT_ADSI_SMCRSRD_CRSRD_INFO ASCI
		INNER JOIN (
		SELECT MAX(ASCI.ETL_DT) AS RCT_ETL_DT
		, ASCI.CRSRD_ID
		, ASCI.MNG_INST_CD
		FROM BIGDATA.EXT_ADSI_SMCRSRD_CRSRD_INFO ASCI
		GROUP BY MNG_INST_CD, CRSRD_ID
		) RCT_ASCI ON RCT_ASCI.MNG_INST_CD = ASCI.MNG_INST_CD and RCT_ASCI.CRSRD_ID = asci.CRSRD_ID AND RCT_ASCI.RCT_ETL_DT = ASCI.ETL_DT
		WHERE 
				1=1
			<if test="name != null and name != ''">
				AND ASCI.CRSRD_NM LIKE '%' || #{name} || '%'
			</if>  
			<if test="id != null and id != ''">
				AND ASCI.CRSRD_ID = #{id}
			</if>  
	</select>
	
	<select id="findAllForMapList" parameterType="adsiSmcrsrdCrsrdInfo" resultType="adsiSmcrsrdCrsrdInfo">
    	SELECT 
    			ASCI.* 
    	FROM 	(
			        SELECT
			        	ROW_NUMBER() OVER(ORDER BY CRSRD_NM DESC) 		AS rownum
			            ,MNG_INST_CD
			            ,CRSRD_ID
			            ,CRSRD_NM
			            ,NODE_ID
			            ,LON_CRDN
			            ,LAT_CRDN
			            ,MAX_TRFVLM
			            ,MAX_PDST_CNT
			        FROM
						BIGDATA.EXT_ADSI_SMCRSRD_CRSRD_INFO ASCI
		INNER JOIN (
		SELECT MAX(ASCI.ETL_DT) AS RCT_ETL_DT
		, ASCI.CRSRD_ID
		, ASCI.MNG_INST_CD
		FROM BIGDATA.EXT_ADSI_SMCRSRD_CRSRD_INFO ASCI
		GROUP BY MNG_INST_CD, CRSRD_ID
		) RCT_ASCI ON RCT_ASCI.MNG_INST_CD = ASCI.MNG_INST_CD and RCT_ASCI.CRSRD_ID = asci.CRSRD_ID AND RCT_ASCI.RCT_ETL_DT = ASCI.ETL_DT
			        WHERE 1=1
			        <if test="crsrdNm != null and crsrdNm != ''">
					AND ASCI.CRSRD_NM LIKE '%' 		|| #{crsrdNm} || '%'
					</if>  
    			) ASCI
    	ORDER BY ASCI.rownum DESC
        <if test="page != null and page != '' and page != 0 ">
		LIMIT 5 OFFSET (#{page} - 1) * 5  	
		</if>
        
    </select>
    
    <select id="countAllForMapList" parameterType="adsiSmcrsrdCrsrdInfo" resultType="int">
        SELECT
            COUNT(*)
        FROM
			BIGDATA.EXT_ADSI_SMCRSRD_CRSRD_INFO ASCI
		INNER JOIN (
		SELECT MAX(ASCI.ETL_DT) AS RCT_ETL_DT
		, ASCI.CRSRD_ID
		, ASCI.MNG_INST_CD
		FROM BIGDATA.EXT_ADSI_SMCRSRD_CRSRD_INFO ASCI
		GROUP BY MNG_INST_CD, CRSRD_ID
		) RCT_ASCI ON RCT_ASCI.MNG_INST_CD = ASCI.MNG_INST_CD and RCT_ASCI.CRSRD_ID = asci.CRSRD_ID AND RCT_ASCI.RCT_ETL_DT = ASCI.ETL_DT
        WHERE 1=1
        <if test="crsrdNm != null and crsrdNm != ''">
		AND CRSRD_NM LIKE '%' 		|| #{crsrdNm} || '%'
		</if>  
    </select>
</mapper>
