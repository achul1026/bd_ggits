<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE mapper PUBLIC '-//mybatis.org//DTD Mapper 3.0//EN' 'http://mybatis.org/dtd/mybatis-3-mapper.dtd'>

<mapper namespace='com.neighbor21.ggits.common.mapper.ScsEmrgVhclCurInfoMapper'>

    <select id="findAll" resultType="scsEmrgVhclCurInfo">
        SELECT
        SEVCI.SERVICEID
        ,SEVCI.EVNO
        ,SEVCI.CURRENTLAT
        ,SEVCI.CURRENTLNG
        ,SEVCI.SPEED
        ,SEVPI.SERVICENAME
        ,SEVPI.ARRIVALLAT
        ,SEVPI.ARRIVALLNG
        ,SEVPI.OCRNO
        ,SEVPI.OCRTYPE
        ,SEVPI.ARRIVALTIME
        ,SEVPI.CURRENTLNG as startlng
        ,SEVPI.CURRENTLAT as startlat
        ,st_asgeojson(sevpi.route) as route_geojson
        <![CDATA[
        ,CASE WHEN MAX(SEVPI.ARRIVALTIME) >= 3600 THEN TO_CHAR(MAX(SEVPI.ARRIVALTIME) * INTERVAL '1 SECOND', 'HH24시 MI분 SS초')
			 WHEN (MAX(SEVPI.ARRIVALTIME) < 3600 AND MAX(SEVPI.ARRIVALTIME) > 60) THEN  TO_CHAR(MAX(SEVPI.ARRIVALTIME) * INTERVAL '1 SECOND', 'MI분 SS초')
			 WHEN MAX(SEVPI.ARRIVALTIME) <= 60 THEN  TO_CHAR(MAX(SEVPI.ARRIVALTIME) * INTERVAL '1 SECOND', 'SS초')
			 ELSE '0'
			 END
			]]>
		AS ARRIVALTIME_FORMAT
        FROM SCS_EMRG_VHCL_CUR_INFO SEVCI
        INNER JOIN SCS_EMRG_VHCL_PATH_INFO SEVPI ON SEVCI.SERVICEID = SEVPI.SERVICEID
        GROUP BY SEVCI.SERVICEID,SEVCI.EVNO,SEVCI.CURRENTLAT,SEVCI.CURRENTLNG,SEVCI.SPEED,SEVPI.SERVICENAME,SEVPI.ARRIVALLAT,SEVPI.ARRIVALLNG ,SEVPI,OCRNO,SEVPI.OCRTYPE,SEVPI.ARRIVALTIME,SEVPI.CURRENTLNG
        ,SEVPI.CURRENTLAT ,SEVPI.ROUTE
    </select>
    
    <select id="findTopTableDataForMonitoringDashboard" resultType="map">
    	SELECT 
			SEVCI.EVNO AS "evno",
			SEVPI.OCRTYPE AS "ocrtype",
			SEVPI.ARRIVALTIME AS "arrivaltime"
		FROM 
			SCS_EMRG_VHCL_CUR_INFO SEVCI
		LEFT JOIN SCS_EMRG_VHCL_PATH_INFO SEVPI 
			ON SEVCI.SERVICEID = SEVPI.SERVICEID AND SEVCI.EVNO = SEVPI.EVNO
		WHERE SEVPI.OCRTYPE IS NOT NULL AND SEVPI.ARRIVALTIME IS NOT NULL
		ORDER BY ARRIVALTIME
    </select>
</mapper>
