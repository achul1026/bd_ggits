<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE mapper PUBLIC '-//mybatis.org//DTD Mapper 3.0//EN' 'http://mybatis.org/dtd/mybatis-3-mapper.dtd'>

<mapper namespace='com.neighbor21.ggits.common.mapper.GgbisBusEventinfoMapper'>

    <select id="findAllRealTimeBusMoveInfo" parameterType="ggbisBusEventinfo" resultType="ggbisBusEventinfo">
		SELECT
				GBE.COLLECT_ID
				,GBE.SERVER_NO
				,GBE.VEH_ID
				,GBE.COLLECT_DATE
				,GBE.LOCATION_ID
				,EGNM.NODE_NAME
				,EGBS.STATION_NM
				,COALESCE((
					CASE
						WHEN GBE.LOCATION_TP = 'I' THEN ST_X(ST_CENTROID(EGNM.GEOMETRY))
						WHEN GBE.LOCATION_TP = 'S' THEN CAST ( LEFT (CAST(EGBS.MAP_X AS VARCHAR), 3 ) AS INT) + CAST( SUBSTRING(CAST(EGBS.MAP_X AS VARCHAR), 4 ) AS DECIMAL(7,3))/ 60
					END
				),0) AS X
				,COALESCE((
					CASE
						WHEN GBE.LOCATION_TP = 'I' THEN ST_Y(ST_CENTROID(EGNM.GEOMETRY))
						WHEN GBE.LOCATION_TP = 'S' THEN CAST(LEFT(CAST(EGBS.MAP_Y AS VARCHAR),2) AS INT) + CAST( SUBSTRING(CAST(EGBS.MAP_Y AS VARCHAR), 3 ) AS DECIMAL(7,3))/ 60
					END
				),0) AS Y
				,GBE.LOCATION_TP
				,GBE.ROUTE_ID
				,GBE.EVENT_CD
				,GBE.SERVICE_TIME
				,GBE.SYSTEM_DATE
				,COALESCE(GBE.GPS_X,0) as GPS_X
				,COALESCE(GBE.GPS_Y,0) as GPS_Y
				,GBE.ERROR_CD
				,GBE.EBCOLLECT_DATE
				,GBE.BMSCOLLECT_DATE
				,GBE.EVENT_TP
				,GBE.PAC_NO
				,GBE.LVEH_CD
				,GBE.LVEH_STATIONID
				,GBE.DOOR_OPCD
				,GBE.REMAINSEAT_CNT
				,GBE.PASSENGER_CNT
				,GBE.TOTALSEAT_CNT
				,GBE.PART_NO
				,GV.COMPANY_ID 								 AS "COMPANY_ID"
				,GV.PLATE_NO 								 AS "PLATE_NO"
				,EGBR.ROUTE_NM 								 AS "ROUTE_NM"
		FROM BIGDATA.EXT_GGBIS_BUS_EVENTINFO GBE
		INNER JOIN (
					SELECT
					MAX(GBE.COLLECT_DATE) AS RCT_COLLECT_DATE
					,GBE.VEH_ID
					,GBE.ROUTE_ID
					FROM
					BIGDATA.EXT_GGBIS_BUS_EVENTINFO GBE
					GROUP BY GBE.VEH_ID ,GBE.ROUTE_ID
					) RCT ON RCT.RCT_COLLECT_DATE = GBE.COLLECT_DATE AND RCT.ROUTE_ID = GBE.ROUTE_ID AND RCT.VEH_ID = GBE.VEH_ID
		LEFT JOIN (
					SELECT
					CGSN.NODE_NAME
					,EGNM.NODE_ID
					,EGNM.ST_NODE_ID
					,CGSN.GEOMETRY
					FROM
					BIGDATA.EXT_GGBIS_NODE_MAPPING EGNM
					INNER JOIN C_GM_STD_NODE CGSN ON CGSN.NODE_ID = EGNM.ST_NODE_ID
					)EGNM ON GBE.LOCATION_TP = 'I' AND EGNM.NODE_ID = GBE.LOCATION_ID
		LEFT JOIN BIGDATA.EXT_GGBIS_BUS_STATION EGBS ON GBE.LOCATION_TP = 'S' AND EGBS.STATION_ID = GBE.LOCATION_ID
		LEFT JOIN BIGDATA.EXT_GGBIS_BUS_ROUTE EGBR ON GBE.ROUTE_ID = EGBR.ROUTE_ID
		LEFT JOIN BIGDATA.EXT_GGBIS_VEHICLE GV ON GBE.VEH_ID = GV.VEH_ID
		WHERE GBE.EVENT_CD != '3' AND GBE.EVENT_CD != '5'
		<if test="routeNm != null and routeNm != '' ">
		AND	EGBR.ROUTE_NM LIKE '%' || #{routeNm} || '%'
		</if>		
		<if test="page != null and page != '' and page != 0 ">
            LIMIT 5 OFFSET (#{page} - 1) * 5
        </if>
    </select>
    
    <select id="countAllRealTimeBusMoveInfo" parameterType="ggbisBusEventinfo" resultType="int">
		SELECT
				COUNT(*)
		FROM BIGDATA.EXT_GGBIS_BUS_EVENTINFO GBE
		INNER JOIN (
					SELECT
					MAX(GBE.COLLECT_DATE) AS RCT_COLLECT_DATE
					,GBE.VEH_ID
					,GBE.ROUTE_ID
					FROM
					BIGDATA.EXT_GGBIS_BUS_EVENTINFO GBE
					GROUP BY GBE.VEH_ID ,GBE.ROUTE_ID
					) RCT ON RCT.RCT_COLLECT_DATE = GBE.COLLECT_DATE AND RCT.ROUTE_ID = GBE.ROUTE_ID AND RCT.VEH_ID = GBE.VEH_ID
		LEFT JOIN (
					SELECT
					CGSN.NODE_NAME
					,EGNM.NODE_ID
					,EGNM.ST_NODE_ID
					,CGSN.GEOMETRY
					FROM
					BIGDATA.EXT_GGBIS_NODE_MAPPING EGNM
					INNER JOIN C_GM_STD_NODE CGSN ON CGSN.NODE_ID = EGNM.ST_NODE_ID
					)EGNM ON GBE.LOCATION_TP = 'I' AND EGNM.NODE_ID = GBE.LOCATION_ID
		LEFT JOIN BIGDATA.EXT_GGBIS_BUS_STATION EGBS ON GBE.LOCATION_TP = 'S' AND EGBS.STATION_ID = GBE.LOCATION_ID
		LEFT JOIN BIGDATA.EXT_GGBIS_VEHICLE GV ON GBE.VEH_ID = GV.VEH_ID
		LEFT JOIN BIGDATA.EXT_GGBIS_BUS_ROUTE EGBR ON GBE.ROUTE_ID = EGBR.ROUTE_ID
		WHERE GBE.EVENT_CD != '3' AND GBE.EVENT_CD != '5'
		<if test="routeNm != null and routeNm != '' ">
		AND	EGBR.ROUTE_NM LIKE '%' || #{routeNm} || '%'
		</if>		
    </select>

	<select id="findAllCurrentByRouteId" resultType="ggbisBusEventinfo">
		SELECT
			DISTINCT ON (VEH_ID, ROUTE_ID)
			MAX(COLLECT_DATE), VEH_ID ,LOCATION_ID ,ROUTE_ID
		FROM
			GGBIS_BUS_EVENTINFO_CUR GBEC
		WHERE ROUTE_ID = #{routeId}
		  AND LOCATION_TP = 'S'
		  AND (EVENT_CD = '01' OR EVENT_CD = '02')
		GROUP BY VEH_ID , LOCATION_ID , ROUTE_ID
	</select>
</mapper>
