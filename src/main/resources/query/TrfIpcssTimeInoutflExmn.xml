<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE mapper PUBLIC '-//mybatis.org//DTD Mapper 3.0//EN' 'http://mybatis.org/dtd/mybatis-3-mapper.dtd'>

<mapper namespace='com.neighbor21.ggits.common.mapper.TrfIpcssTimeInoutflExmnMapper'>
	
	<select id="findAllTimeInoutflExmnList" parameterType="trfvlmStatisticsDTO" resultType="timeInoutflExmnDTO">
		SELECT 
			TRFVLM_RESULT.TIME_SCTN_NM,
			JSON_AGG(TRFVLM_RESULT.TRFVLM_OBJECT ORDER BY SUBSTRING(TRFVLM_RESULT.USG_NO::VARCHAR, 3,1 ),TRFVLM_RESULT.ACT_POPLTN_EXMN_TYPE ASC) AS TRFVLM_STATISTICS_LIST_JSON
		FROM(
			SELECT
				TIME_SCTN_NM,
				USG_NO,
				ACT_POPLTN_EXMN_TYPE,
				FORMAT('{%s}', STRING_AGG(FORMAT('"%s":"%s","%s":"%s","%s":"%s","%s":"%s","%s":"%s","%s":"%s"', 
												'resdngInfl', TICTI.RESDNG_INFL,
												'resdngOutfl', TICTI.RESDNG_OUTFL,
												'visitInfl', TICTI.VISIT_INFL,
												'visitOutfl', TICTI.VISIT_OUTFL,
												'totInfl', TICTI.TOT_INFL,
												'totOutfl', TICTI.TOT_OUTFL
												), ', '))::JSON AS TRFVLM_OBJECT
			FROM (
				SELECT
					TIME_SCTN_NM,
					USG_NO,
					ACT_POPLTN_EXMN_TYPE,
					RESDNG_INFL,
					RESDNG_OUTFL,
					VISIT_INFL,
					VISIT_OUTFL,
					TOT_INFL,
					TOT_OUTFL
				FROM
					TRF_IPCSS_TIME_INOUTFL_EXMN
				WHERE IPCSS_MNG_NO = #{ipcssMngNo}
				GROUP BY TIME_SCTN_NM,USG_NO,ACT_POPLTN_EXMN_TYPE,RESDNG_INFL,RESDNG_OUTFL,VISIT_INFL,VISIT_OUTFL,TOT_INFL,TOT_OUTFL
			) TICTI
			GROUP BY TICTI.TIME_SCTN_NM,TICTI.USG_NO,TICTI.ACT_POPLTN_EXMN_TYPE
			ORDER BY TICTI.TIME_SCTN_NM,TICTI.USG_NO,TICTI.ACT_POPLTN_EXMN_TYPE
		) TRFVLM_RESULT
		GROUP BY 	TRFVLM_RESULT.TIME_SCTN_NM
		ORDER BY 	TRFVLM_RESULT.TIME_SCTN_NM
	</select>
	
	<select id="findOneUsgCdNmList" parameterType="trfvlmStatisticsDTO" resultType="map">
		WITH TIME_INOUTFL_LIST AS(
			SELECT 
				TRFVLM_RESULT.USG_NM
			FROM(
				SELECT
					USG_NM
				FROM (
					SELECT
						titie.USG_NM
					FROM
						TRF_IPCSS_TIME_INOUTFL_EXMN titie
					WHERE titie.IPCSS_MNG_NO = #{ipcssMngNo}
					GROUP BY titie.USG_NM
				) TICTI
				GROUP by TICTI.USG_NM
				ORDER BY TICTI.USG_NM
			) TRFVLM_RESULT
			GROUP BY TRFVLM_RESULT.USG_NM
			ORDER BY TRFVLM_RESULT.USG_NM
		)
			
		SELECT ARRAY_TO_STRING(ARRAY_AGG(usg_nm), ',') AS cdNmArr FROM TIME_INOUTFL_LIST
	</select>
	
	<select id="findAllChartData" parameterType="trfvlmStatisticsDTO" resultType="map">
		WITH TIME_INOUTFL_ARRAY_LIST AS (
			SELECT
				TIME_DATA.GRAPH_TIME
				,COALESCE(GRAPH_DATA.RESDNG_INFL,0) as RESDNG_INFL
				, COALESCE(GRAPH_DATA.RESDNG_OUTFL,0) as RESDNG_OUTFL
				,COALESCE(GRAPH_DATA.VISIT_INFL,0) as VISIT_INFL
				, COALESCE(GRAPH_DATA.VISIT_OUTFL,0) as VISIT_OUTFL
				,COALESCE(GRAPH_DATA.TOT_INFL,0) as TOT_INFL
				, COALESCE(GRAPH_DATA.TOT_OUTFL,0) as TOT_OUTFL
			FROM(
				SELECT
					TO_CHAR(GENERATE_SERIES(TO_TIMESTAMP('2023-11-22 00','YYYY-MM-DD HH24'),TO_TIMESTAMP('2023-11-22 23','YYYY-MM-DD HH24'),'1 hours'),'HH24') as GRAPH_TIME         
			) TIME_DATA
		LEFT JOIN (
				SELECT
					SUM(RESDNG_INFL) as RESDNG_INFL,
					SUM(RESDNG_OUTFL) as RESDNG_OUTFL,
					SUM(VISIT_INFL) as VISIT_INFL,
					SUM(VISIT_OUTFL) as VISIT_OUTFL,
					SUM(TOT_INFL) as TOT_INFL,
					SUM(TOT_OUTFL) as TOT_OUTFL,
					SUBSTRING(time_sctn_nm,1,2) as timeSctnNm
				FROM
					TRF_IPCSS_TIME_INOUTFL_EXMN
				WHERE 1=1
					AND IPCSS_MNG_NO = #{ipcssMngNo}
					AND ACT_POPLTN_EXMN_TYPE = '1'
				GROUP BY 
					SUBSTRING(TIME_SCTN_NM,1,2)
				ORDER BY timeSctnNm ASC	
	  	) GRAPH_DATA on TIME_DATA.GRAPH_TIME = GRAPH_DATA.timeSctnNm
			ORDER BY
			TIME_DATA.GRAPH_TIME ASC
			) 
			SELECT 
				 ARRAY_TO_STRING(ARRAY_AGG(RESDNG_INFL),',') AS resdngInflRtDataArray,
				 ARRAY_TO_STRING(ARRAY_AGG(RESDNG_OUTFL),',') AS resdngOutflRtDataArray,
				 ARRAY_TO_STRING(ARRAY_AGG(VISIT_INFL),',') AS visitInflRtDataArray,
				 ARRAY_TO_STRING(ARRAY_AGG(VISIT_OUTFL),',') AS visitOutflRtDataArray,
				 ARRAY_TO_STRING(ARRAY_AGG(TOT_INFL),',') AS totInflRtDataArray,
				 ARRAY_TO_STRING(ARRAY_AGG(TOT_OUTFL),',') AS totOutflRtDataArray,
				 ARRAY_TO_STRING(ARRAY_AGG(GRAPH_TIME order by GRAPH_TIME),',') AS timeDataArray
			FROM 
				TIME_INOUTFL_ARRAY_LIST		
	</select>
	
	<select id="findAllInoutCntSumList" parameterType="map" resultType="trfIpcssTimeInoutflExmn">
		SELECT 
			SUM(B.RESDNG_INFL) as RESDNG_INFL ,
			SUM(B.RESDNG_OUTFL) as RESDNG_OUTFL ,
			SUM(B.VISIT_INFL) as VISIT_INFL ,
			SUM(B.VISIT_OUTFL) as VISIT_OUTFL ,
			SUM(B.TOT_INFL) as TOT_INFL ,
			SUM(B.TOT_OUTFL) as TOT_OUTFL 
		FROM(
			SELECT 
				A.TIME_SCTN_NM,
				COALESCE(SUM(A.RESDNG_INFL),0) as RESDNG_INFL ,
				COALESCE(SUM(A.RESDNG_OUTFL),0) as RESDNG_OUTFL ,
				COALESCE(SUM(A.VISIT_INFL),0) as VISIT_INFL ,
				COALESCE(SUM(A.VISIT_OUTFL),0) as VISIT_OUTFL ,
				COALESCE(SUM(A.TOT_INFL),0) as TOT_INFL ,
				COALESCE(SUM(A.TOT_OUTFL),0) as TOT_OUTFL 
			FROM (
				SELECT
					TIME_SCTN_NM,
					USG_NO,
					ACT_POPLTN_EXMN_TYPE,
					RESDNG_INFL,
					RESDNG_OUTFL,
					VISIT_INFL,
					VISIT_OUTFL,
					TOT_INFL,
					TOT_OUTFL
				FROM
					TRF_IPCSS_TIME_INOUTFL_EXMN
				WHERE IPCSS_MNG_NO = #{ipcssMngNo} and usg_nm = #{usgNm}
				AND ACT_POPLTN_EXMN_TYPE = '1'
				GROUP BY TIME_SCTN_NM,USG_NO,ACT_POPLTN_EXMN_TYPE,RESDNG_INFL,RESDNG_OUTFL,VISIT_INFL,VISIT_OUTFL,TOT_INFL,TOT_OUTFL
			)A
			GROUP BY TIME_SCTN_NM
		)B
	</select>
	
	<select id="findAllInoutRateSumList" parameterType="map" resultType="trfIpcssTimeInoutflExmn">
		SELECT 
			(SUM(B.RESDNG_INFL)/100) as RESDNG_INFL ,
			(SUM(B.RESDNG_OUTFL)/100) as RESDNG_OUTFL ,
			(SUM(B.VISIT_INFL)/100) as VISIT_INFL ,
			(SUM(B.VISIT_OUTFL)/100) as VISIT_OUTFL ,
			(SUM(B.TOT_INFL)/100) as TOT_INFL ,
			(SUM(B.TOT_OUTFL)/100) as TOT_OUTFL
		FROM(
			SELECT 
				A.TIME_SCTN_NM,
				COALESCE(SUM(A.RESDNG_INFL),0) as RESDNG_INFL ,
				COALESCE(SUM(A.RESDNG_OUTFL),0) as RESDNG_OUTFL ,
				COALESCE(SUM(A.VISIT_INFL),0) as VISIT_INFL ,
				COALESCE(SUM(A.VISIT_OUTFL),0) as VISIT_OUTFL ,
				COALESCE(SUM(A.TOT_INFL),0) as TOT_INFL ,
				COALESCE(SUM(A.TOT_OUTFL),0) as TOT_OUTFL 
			FROM (
				SELECT
					TIME_SCTN_NM,
					USG_NO,
					ACT_POPLTN_EXMN_TYPE,
					RESDNG_INFL,
					RESDNG_OUTFL,
					VISIT_INFL,
					VISIT_OUTFL,
					TOT_INFL,
					TOT_OUTFL
				FROM
					TRF_IPCSS_TIME_INOUTFL_EXMN
				WHERE IPCSS_MNG_NO = #{ipcssMngNo} and usg_nm = #{usgNm}
				AND ACT_POPLTN_EXMN_TYPE = '2'
				GROUP BY TIME_SCTN_NM,USG_NO,ACT_POPLTN_EXMN_TYPE,RESDNG_INFL,RESDNG_OUTFL,VISIT_INFL,VISIT_OUTFL,TOT_INFL,TOT_OUTFL
			)A
			GROUP BY TIME_SCTN_NM
		)B
	</select>

	<insert id="saveTimeInoutflExmn" parameterType="trfIpcssTimeInoutflExmn">
		INSERT INTO TRF_IPCSS_TIME_INOUTFL_EXMN(
			IPCSS_MNG_NO, 
			EXMN_YMD, 
			DYWK_DIV, 
			USG_NO, 
			USG_NM, 
			TIME_SCTN_NM, 
			ACT_POPLTN_EXMN_TYPE, 
			RESDNG_INFL, 
			RESDNG_OUTFL, 
			VISIT_INFL, 
			VISIT_OUTFL, 
			TOT_INFL, 
			TOT_OUTFL
			)VALUES(
			#{ipcssMngNo}, 
			#{exmnYmd}, 
			#{dywkDiv}, 
			#{usgNo}, 
			#{usgNm}, 
			#{timeSctnNm}, 
			#{actPopltnExmnType}, 
			#{resdngInfl}, 
			#{resdngOutfl}, 
			#{visitInfl}, 
			#{visitOutfl}, 
			#{totInfl}, 
			#{totOutfl})
	</insert>
	
	<delete id="deleteTrafficImpactReportByIpcssMngNo" parameterType="String">
		DELETE 
			FROM
				TRF_IPCSS_TIME_INOUTFL_EXMN
		WHERE
			IPCSS_MNG_NO = #{ipcssMngNo}
	</delete>
</mapper>
