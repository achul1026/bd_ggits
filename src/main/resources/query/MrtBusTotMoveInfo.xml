<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE mapper PUBLIC '-//mybatis.org//DTD Mapper 3.0//EN' 'http://mybatis.org/dtd/mybatis-3-mapper.dtd'>

<mapper namespace='com.neighbor21.ggits.common.mapper.MrtBusTotMoveInfoMapper'>
	<sql id="mrtBusTotMoveInfo-Where">
		<if test="(strDt != '' and strDt != '') and (endDt != '' and endDt != null)">
			AND mbtmi.ANLS_DT 
			BETWEEN TO_TIMESTAMP(#{strDt}|| ' 00:00:00', 'YYYY-MM-DD HH24:MI:SS') 
		    	AND TO_TIMESTAMP(#{endDt}|| ' 23:59:59', 'YYYY-MM-DD HH24:MI:SS')
		</if>
		<if test="(strDt != '' and strDt != null) and (endDt == '' or endDt == null)">
			<![CDATA[
			AND TO_TIMESTAMP(#{strDt}, 'YYYY-MM-DD HH24:MI:SS')  <= mbtmi.ANLS_DT
			]]>
		</if>
		<if test="(strDt == '' or strDt == null) and (endDt != '' and endDt != null)">
			<![CDATA[
			AND mbtmi.ANLS_DT <= TO_TIMESTAMP(#{endDt}, 'YYYY-MM-DD HH24:MI:SS')
			]]>
		</if>
		<if test="dayOfTheWeek != null">
			AND EXTRACT (ISODOW from mbtmi.ANLS_DT)::varchar(1) IN 
				<foreach collection="dayOfTheWeek" item="item" index="index" separator="," open="(" close=")">
                    #{item}
                </foreach>
		</if>
	</sql>

	<select id="countBusTotMoveInfoList" parameterType="commonEntity" resultType="int">
		SELECT 
			COUNT(1)
		FROM MRT_BUS_TOT_MOVE_INFO mbtmi
		INNER JOIN (
		SELECT
		EGAP.ROUTE_ID,
		EGAP.EB_ROUTE_ID
		FROM
		BIGDATA.EXT_GGBIS_ALLOCATION_PLAN EGAP
		GROUP BY
		EGAP.ROUTE_ID,
		EGAP.EB_ROUTE_ID
		) EBINFO ON MBTMI.BUS_ROUTE_ID = EBINFO.ROUTE_ID
		INNER JOIN BIGDATA.EXT_GGBIS_BUS_ROUTE EGBR ON EBINFO.ROUTE_ID = EGBR.ROUTE_ID
		WHERE 
			1=1
			<include refid="mrtBusTotMoveInfo-Where"/>
	</select>
	
	<select id="findAllMrtBusToMoveInfo" parameterType="commonEntity" resultType="mrtBusTotMoveInfo">
		SELECT
			egbr.ROUTE_NM
			, egbr.ST_STA_NM
			, egbr.ED_STA_NM
			, mbtmi.MVMN_DSTNE
		FROM MRT_BUS_TOT_MOVE_INFO MBTMI
		INNER JOIN (
		SELECT
		EGAP.ROUTE_ID,
		EGAP.EB_ROUTE_ID
		FROM
		BIGDATA.EXT_GGBIS_ALLOCATION_PLAN EGAP
		GROUP BY
		EGAP.ROUTE_ID,
		EGAP.EB_ROUTE_ID
		) EBINFO ON MBTMI.BUS_ROUTE_ID = EBINFO.ROUTE_ID
		INNER JOIN BIGDATA.EXT_GGBIS_BUS_ROUTE EGBR ON EBINFO.ROUTE_ID = EGBR.ROUTE_ID
		WHERE 
			1=1
			<include refid="mrtBusTotMoveInfo-Where"/>
		ORDER BY mbtmi.ANLS_DT DESC
		LIMIT 10 OFFSET (#{page} - 1) * 10
	</select>
</mapper>
